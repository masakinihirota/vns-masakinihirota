# src 機能レビュー（2025-12-13）

対象: `src/` 配下（ルート/画面、API、認証、レイアウト、主要コンポーネント、lib、config、types）

## 0. まとめ（重要度順）

- **認証コールバック失敗時の遷移先が未実装**: `/auth/auth-code-error` へのリダイレクト先ページが `src/app` に存在しないため 404 になり得ます。
- **Supabase「Proxy」確認完了 (Next.js 16)**: `src/proxy.ts` は Next.js 16 (Canary) の仕様に基づく正しい配置です（従来の `middleware.ts` 相当）。現状で正常にセッション更新が動作します。
- **テストが破綻している可能性**: `sample` のテスト内容が現実装と一致していません。また `tutorial` が stub なのに `AppSidebar` のテストはLv制の挙動を期待しています。
- **ルーティングの整合性不足**: メニューは manifest 上の `/search` 等に遷移する一方、ヘッダー検索は `/home/search` に遷移しており、設計意図が混在しています。
- **DB型定義が実スキーマと乖離**: `src/types/types_db.ts` の `public.Tables` が空で、`root_accounts`/`user_profiles` を型安全に扱えていません。

---

## 1. ルート/アプリシェル

### 1-1. ルートレイアウト（App Router）

- 対象: `src/app/layout.tsx`, `src/app/globals.css`
- 良い点: font 最適化（Geist）を利用、シンプル。
- 気になる点:
  - `lang="en"` と英語 metadata がデフォルトのまま。
  - 全体テーマ/デザイン指針とログイン画面のスタイルが乖離しやすい。

### 1-2. トップページ

- 対象: `src/app/page.tsx`
- 良い点: `/sample` と `/login` への導線が明確。
- 気になる点: いずれも導線先のUXがまだ「開発中」前提。

---

## 2. 認証（Public）

### 2-1. ログイン画面（認証方式選択）

- 対象: `src/app/(public)/login/page.tsx`
- 良い点: 匿名/Google/GitHub の比較が明確。
- 気になる点:
  - Tailwind の `bg-black`/`text-white`/`text-gray-*` など、テーマ変数ではない色指定が多く、デザインシステムと乖離しやすい。

### 2-2. 匿名ログイン

- 対象: `src/components/auth/anonymous-login-form.tsx`
- 良い点: `signInAnonymously()` の結果を見て `/home` に遷移。
- 気になる点:
  - 成功時に `console.log` が残っている（将来的に整理推奨）。
  - 「匿名ログインの機能リスト」が固定値で、サーバー側の権限制御と同期していない（UIのみで誤解を招きやすい）。

### 2-3. OAuth（Google / GitHub）

- 対象: `src/components/auth/google-login-form.tsx`, `src/components/auth/github-login-form.tsx`
- 良い点: `redirectTo: ${window.location.origin}/auth/callback?next=/home` に統一。
- 気になる点:
  - `window` 利用のため当然 Client Component 前提。OKだが、SSR との責務分離は維持したい。

### 2-4. 認証コールバック（Route Handler）

- 対象: `src/app/(public)/auth/callback/route.ts`
- 良い点:
  - Email OTP (`verifyOtp`) と OAuth code (`exchangeCodeForSession`) 両対応。
  - `next` のオープンリダイレクト対策（`startsWith("/")`）が入っている。
- 気になる点:
  - 失敗時の遷移先 `/auth/auth-code-error` が未実装（404 になり得る）。
  - Supabase公式の注意点では SSR 保護に `getClaims()` を推奨（`getUser()`/`getSession()` だけだと誤判定リスク）。

---

## 3. 保護領域（Protected）

### 3-1. Protected レイアウト（認証ガード）

- 対象: `src/app/(protected)/layout.tsx`
- 良い点: `supabase.auth.getUser()` で未ログインを `/login` へ。
- 気になる点:
  - Supabase公式ではサーバー側の保護は `getClaims()` がより安全という注意がある（今後の方針として検討）。
  - 現状は「Proxy（セッション更新）」が未配線の可能性があり、長時間利用時の挙動は要検証。

### 3-2. /home（ダッシュボード）

- 対象: `src/app/(protected)/home/page.tsx`
- 良い点: まずは skeleton 的なプレースホルダとして妥当。
- 気になる点: 実データ/機能未接続。

---

## 4. API（Hono on Edge）

### 4-1. Catch-all API

- 対象: `src/app/api/[[...route]]/route.ts`
- 良い点:
  - `runtime = "edge"` で Edge 前提。
  - Hono の `handle(app)` による HTTP メソッド網羅。
- 気になる点:
  - `basePath("/api")` と Next.js の `/api/*` が二重にならないか、`/api/hello` が期待通り動くか要確認。
  - 認証/レート制限/CORS 方針が未記載（今後の実装タイミングで要整理）。

---

## 5. サンプル機能（プロフィール一覧のデモ）

### 5-1. /sample

- 対象: `src/app/sample/page.tsx`
- 良い点: `ProfileListContainer` のデモとして分かりやすい。

### 5-2. /sample のテスト

- 対象: `src/app/sample/page.test.tsx`
- 気になる点:
  - 現在の `page.tsx` のUIと、テストが期待している文言/リンクが一致していないため、失敗する可能性が高い。

---

## 6. レイアウトコンポーネント

### 6-1. サイドバー

- 対象: `src/components/layout/AppSidebar.tsx`, `src/config/routes.manifest.json`, `src/lib/tutorial/tutorial.ts`
- 良い点:
  - manifest 駆動でメニューを組み立てており拡張しやすい。
  - 「Lv制」のための state 付与フックが用意されている。
- 気になる点:
  - `tutorial.ts` は現状 stub（常に unlocked）なのに、テストは grayed/hidden を期待している。
  - manifest 上の多くのパス（`/matching` 等）が `src/app` にまだ存在しないため、導線は 404 を起こしやすい。

### 6-2. グローバルヘッダー

- 対象: `src/components/layout/GlobalHeader.tsx`
- 良い点: 機能要件を一通り UI で表現（検索、通知、ポイント、テーマ等）。
- 気になる点:
  - ヘッダー検索は `/home/search` に push する一方、manifest では `/search` が存在し、ルーティング設計が混在。
  - 多くがモックデータで、実データ接続時の責務分割（API/Server Actions 等）は今後要検討。

### 6-3. フッター

- 対象: `src/components/layout/footer.tsx`, `src/config/nav.ts`
- 良い点: `footerNav` で拡張しやすい。
- 気になる点: `/help` 等の遷移先が未実装だと 404。

---

## 7. プロフィール一覧（components/profile-list）

### 7-1. ロジック（純関数）

- 対象: `src/components/profile-list/profile-list/profile-list.logic.ts`
- 良い点:
  - 純関数/不変性を守れている。
  - `localeCompare("ja")` を使い日本語ソートを意識。

### 7-2. UI / コンテナ

- 対象: `src/components/profile-list/profile-list/profile-list.tsx`, `profile-list.container.tsx`
- 良い点:
  - コロケーション＋ロジック分離が明確。
  - `aria-*`/`role` の配慮が入っている。
- 気になる点:
  - Tailwind 色指定（青/黄/灰）が固定で、テーマ変数より DADS 優先になっている。方針としてOKか整理が必要。

### 7-3. テスト

- 対象: `profile-list.logic.test.ts`, `profile-list.logic.integration.test.ts`, `profile-list.test.tsx`
- 良い点: 単体・結合・UI の粒度が揃っている。

---

## 8. DADS コンポーネント（components/dads）

- 対象: `src/components/dads/Button.tsx`, `Input.tsx`, `Slot.tsx`
- 良い点:
  - `aria-disabled` を考慮した挙動が入っている。
  - Slot パターンで asChild が可能。
- 気になる点:
  - Tailwind token の前提（`blue-1000` 等）がプロジェクトの Tailwind 設定に依存。存在しない場合はスタイルが崩れる。

---

## 9. UI プリミティブ（components/ui）

- 対象: `src/components/ui/*`（shadcn/radix 系）
- 良い点: `src/components/ui/index.ts` の barrel export で利用側が簡潔。
- 気になる点:
  - `alert-dialog.tsx` 等、存在するが `index.ts` から export されていないものがある（方針として意図的か確認推奨）。

---

## 10. Supabase / DB

### 10-1. Supabase クライアント

- 対象: `src/lib/supabase/client.ts`, `src/lib/supabase/server.ts`, `src/lib/supabase/middleware.ts`
- 良い点:
  - Supabase SSR の基本形に沿っている。
  - Next.js の `cookies()` が async である前提で実装されており、Next.js 15+ 互換。
- 気になる点:
  - `.env.local` 内に機密情報が含まれる場合、Git 管理対象外であることを必ず確認（漏洩時はローテーション）。
  - Supabase公式では Proxy が必要（Server Components は cookie を書けないため）。本リポジトリでは Proxy の配置/命名が未整合の可能性。

### 10-2. DBアクセス

- 対象: `src/lib/db/root-accounts.ts`, `src/lib/db/user-profiles.ts`
- 良い点: 実装が簡潔で読みやすい。
- 気になる点:
  - `types_db.ts` が空のため型安全が効いていない。
  - `createUserProfile` の上限チェックは race condition があり得る（本番ではDB制約・RLS・トランザクション方針も要検討）。

---

## 11. 型定義（types）

- 対象: `src/types/types_db.ts`, `src/types/index.ts`
- 気になる点:
  - `Database.public.Tables` が空。`root_accounts`/`user_profiles` を参照している現実装と不整合。

---

## 12. フック

- 対象: `src/hooks/use-mobile.tsx`
- 良い点: sidebar に必要な最小実装。
- 気になる点:
  - 初期値が `undefined` だが返り値は `!!isMobile` で常に boolean（初回 false 固定）になり、UI上のチラつき/判定誤差が出る場合がある。

---

## 13. Proxy（Supabase セッション更新）

- 対象: `src/proxy.ts`
- 良い点: Supabase公式 docs の Proxy 形に近い。
- 気になる点:
  - Next.js 16 では `middleware.ts` ではなく `proxy.ts` が標準となっており、`src/proxy.ts` の配置は仕様通りです。動作上の問題はありません。

---

## 14. 次のアクション案（レビュー観点から）

- 404 の解消: `/auth/auth-code-error`、manifest にある主要ルートのどれを実装するか優先度付け。
- Proxy の正規配線: Supabase公式の最新ガイドに沿って、Next.js が確実に認識する場所へ移動/命名。
- テスト整合: `sample` と `tutorial` のテストを、現状実装に合わせて整理。
- ルーティング設計統一: `/search` を正とするか `/home/search` を正とするか決めて揃える。
- DB型生成: Supabase schema から `types_db.ts` を更新し、`select("*")` を段階的に型安全化。
