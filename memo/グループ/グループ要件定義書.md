# グループ機能 要件定義書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | グループ機能 要件定義書 |
| バージョン | 1.0 |
| 作成日 | 2025-10-10 |
| 作成者 | masakinihirota |
| 対象システム | VNS (Value Network Service) - masakinihirota |
| ステータス | レビュー中 |

---

## 目次

1. [はじめに](#1-はじめに)
2. [グループの基本構造](#2-グループの基本構造)
3. [階層構造と自動スケーリング](#3-階層構造と自動スケーリング)
4. [システムグループ](#4-システムグループトップダウン形式)
5. [ロールと権限](#5-ロールと権限rbac)
6. [メンバー管理](#6-メンバー管理)
7. [ペナルティシステム](#7-ペナルティシステム)
8. [ルール設定](#8-ルール設定)
9. [セキュリティ要件](#9-セキュリティ要件)
10. [UI/UX要件](#10-uiux要件)
11. [ゲーム化要素](#11-ゲーム化要素)
12. [未解決の課題](#12-未解決の課題)
13. [実装の優先度](#13-実装の優先度)

---

## 1. はじめに

### 1.1 目的

本要件定義書は、VNS「masakinihirota」におけるグループ機能（オアシス）を、**クリエイターの保護**と**幸福追求権の優先**という基本原則に則り、Next.jsおよびSupabaseを用いて安全かつ拡張性高く実装するための要件を定義します。

特に、以下の点を重視します：
- ユーザーの役割（ロール）に基づいた厳格なアクセス制御（RBAC）
- データベース層でのデータ保護（RLS）
- 価値観ベースの自動マッチング
- ボトムアップ方式による階層的なコミュニティ形成

### 1.2 採用技術スタック

- **フロントエンド:** Next.js 15 (App Router), React, TypeScript
- **バックエンド/データベース:** Supabase (PostgreSQL, Auth, RLS)
- **権限管理:** RLS (Row Level Security) および RBAC (Role-Based Access Control)
- **ORM:** Drizzle ORM
- **スキーマ検証:** Zod

### 1.3 VNSの基本原則（オアシス宣言）

すべてのグループに適用される基本原則：

1. **幸福追求権の優先**: 表現の自由（日本国憲法第21条）と幸福追求権（日本国憲法第13条）が衝突する場合、必ず幸福追求権を優先
2. **クリエイター保護**: コンテンツを創造するクリエイターの権利と利益を最優先
3. **ヘイト発言等の禁止**: ネガティブな発言やヘイトスピーチは禁止
4. **ボトムアップ方式**: 少数のグループでの運営と拡大を基本とする
5. **価値観の一致**: マッチングの基本は価値観、対立するグループは自動調整で分離

---

## 2. グループの基本構造

### 2.1 グループの2つの種類

VNSのグループには**自動グループ**と**手動グループ**の2種類があります。

#### 2.1.1 自動グループ

**最重要原則**: 複雑なシステムはできる限り表に出さない

**特徴**:
- ユーザープロフィール作成で自動的にグループ生成
- 価値観マッチングで自動的にメンバーが追加される
- 条件を満たせば自動で上位階層に昇格
- 統廃合もすべて自動化
- **リーダーの役割は「メンバーの処分（ペナルティ）」のみ**

**完全自動化される要素**:
1. グループ作成（ユーザープロフィール作成時）
2. メンバーマッチング（価値観ベース）
3. **メンバー追加（フォロー申請 → 自動フォローバック）**
4. 人数カウント表示（リアルタイム更新）
5. 階層昇格（50%ルール）
6. 統廃合（上限到達時）
7. 通知（人数変化、昇格、統廃合）

**自動マッチングとフォロー申請**:
```
【リーダーが「自動マッチング」を選択している場合】
1. システムが価値観の近い人を自動検出
   ↓
2. 候補者が自動的にフォロー申請
   ↓
3. リーダーがフォローバック（自動承認）
   ↓
4. 即座に相互フォロー状態（正式メンバー）

→ リーダーの手間: ゼロ
```

**リーダーが行うこと**:
- ❌ メンバー募集（自動）
- ❌ 人数管理（自動）
- ❌ 昇格判断（自動）
- ❌ フォロー申請の承認（自動）
- ✅ **ペナルティ判断のみ**（注意、警告、カード、リーブ）

**リーダーの画面に表示される情報**:
```
現在の人数: 7/10人 ← 自動更新
階層レベル: グループ（レベル1）
新規メンバー: 田中太郎 さんが参加しました ← 自動通知
```

#### 2.1.2 手動グループ

**特徴**:
- リーダーが一人ひとりの**ユーザープロフィールを目視確認**
- フォロー申請を**リーダーが個別に承認/拒否**
- 価値観、作品、重要マークをリーダー自身の目で判断
- メンバーの質を厳選できる

**手動マッチングとフォロー申請**:
```
【リーダーが「手動マッチング」を選択している場合】
1. システムがマッチングスコアを計算して候補表示
   ↓
2. リーダーが候補者のプロフィールを目視確認
   ・価値観の回答
   ・好きな作品
   ・重要マーク
   ・過去の投稿
   ↓
3. リーダーが承認/拒否を判断
   ・承認 → フォローバック → 相互フォロー状態
   ・拒否 → 申請却下
   ・ウォッチに追加 → 様子見
```

**リーダーが行うこと**:
- ✅ **フォロー申請の一つずつ確認**
- ✅ **ユーザープロフィールを目で判断**
- ✅ **承認/拒否の判断**
- ✅ **ペナルティ判断**

**リーダーの画面に表示される情報**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
📬 フォロー申請（3件）
━━━━━━━━━━━━━━━━━━━━━━━━━━━

候補ユーザー: 田中太郎
マッチングスコア: 87%

【価値観一致度】 92%
✅ クリエイター保護 ⭐⭐（両者重要視）
✅ ヘイト発言 ⭐（片方のみ）
✅ 表現の自由（一致）

【好きな作品】
共通作品: 5個
- 「進撃の巨人」Tier 1 ✅

[承認する] [ウォッチに追加] [拒否]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```
次の昇格: あと3人で村に自動昇格
統廃合状態: 正常
```

#### 2.1.2 手動グループ

**特徴**:
- リーダーが**ユーザープロフィール同士を自分の目で比較**してフォロー判断
- マッチングスコアを見ながら個別に選定
- メンバー追加は手動承認制
- グループの方向性をリーダーが細かくコントロール
- 昇格は手動判断（自動昇格も選択可能）

**手動選定のプロセス**:
```
1. ユーザープロフィール検索
   ↓
2. マッチングスコア表示（システムが計算）
   ・価値観の一致度: 85%
   ・目的の一致: 仕事
   ・重要価値観: クリエイター保護
   ↓
3. リーダーが目視で判断
   ・プロフィール詳細を確認
   ・過去の投稿/作品を確認
   ↓
4. ウォッチ または フォロー
   ↓
5. 手動承認
```

**リーダーの責務**:
- メンバーの選定と承認（**自分の目で判断**）
- メンバーの発言の責任を負う
- グループの運営方針決定
- ペナルティの判断と実行

### 2.2 グループの基本定義

| 項目 | 内容 |
|------|------|
| 最大人数 | 10人まで |
| 構成 | リーダー1人 + メンバー最大9人 |
| 作成方法 | ユーザープロフィール作成時に自動生成 |
| マッチング方式 | 価値観ベースの自動マッチング（1日1回無料） |
| 階層レベル | レベル1（最小単位） |

### 2.3 ユーザープロフィール作成とグループ参加の流れ

#### 2.3.1 リーダーになる場合

```
1. ユーザー認証（OAuth: Google, GitHub等）
   ↓
2. ルートアカウント作成（システム全体で一意）
   ↓
3. ユーザープロフィール作成
   ・価値観の回答（ベーシック必須）
   ・目的設定（仕事、遊び、婚活など）
   ↓
4. 参加方法の選択
   【選択肢1】リーダーとしてグループを作成
   【選択肢2】メンバーとして既存グループに参加
   ↓
5-A. リーダーを選択した場合
   ↓
6-A. グループタイプ選択
   ・自動グループ：システムが自動運営
   ・手動グループ：リーダーが手動管理
   ↓
7-A. 最小グループ自動生成
   ・作成者が自動的にリーダーに
   ・グループ名、説明、ルールの設定可能
```

#### 2.3.2 メンバーのみとして参加する場合

```
5-B. メンバーのみを選択した場合
   ↓
6-B. 自動マッチング開始
   ・システムが価値観の近いグループを検索
   ・マッチングスコア上位のグループを提案
   ↓
7-B. 自動的にグループに参加
   ・リーダーが「自動マッチング」を選択しているグループ
   ・フォロー申請 → 自動フォローバック
   ・即座にメンバーとして参加
   ↓
8-B. 最小単位グループの階層に配置
   ・どこかのグループのメンバーになる
   ・リーダーにはならない（選ばれない）
```

**重要な違い**:
```
【リーダーとして参加】
✅ 自分のグループを持つ
✅ メンバー管理の責任を負う
✅ ペナルティ権限を持つ
✅ リーダー選挙の候補になる
✅ プレパートーナー・パートナー関係が可能

【メンバーのみとして参加】
✅ どこかのグループに所属（メンバー）
✅ ウォッチ（観察）は可能
✅ フォロー（応援）は可能
❌ リーダーにはならない（復帰するまで）
❌ 自分のグループは持たない
❌ リーダー選挙の候補にならない
❌ プレパートーナーにはなれない
❌ パートナーにはなれない
✅ いつでもリーダーに復帰可能（設定変更）
```

**メンバーのみ参加時の制限詳細**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
関係の段階と制限
━━━━━━━━━━━━━━━━━━━━━━━━━━━

【ウォッチ】観察
✅ 許可: グループやユーザーを観察できる
✅ 内容: 公開情報の閲覧のみ

【フォロー】応援
✅ 許可: グループに参加申請できる
✅ 内容: メンバーとしてグループ活動に参加

━━━━━━━━━━━━━━━━━━━━━━━━━━━
【ここから先はリーダー復帰が必要】
━━━━━━━━━━━━━━━━━━━━━━━━━━━

【プレパートーナー】婚活相手候補
❌ 制限: リーダー経験が必要
❌ 理由: 責任を負う覚悟の証明

【パートーナー】結婚相手・恋人
❌ 制限: リーダー経験が必要
❌ 理由: 人生の重要な決断に責任能力が必須

━━━━━━━━━━━━━━━━━━━━━━━━━━━
※リーダー復帰手順:
1. ユーザープロフィール設定で「リーダー資格: 有効」
2. 「リーダーに復帰」を選択
3. 新しいグループ作成 or ドリフトから復帰
4. プレパートーナー・パートーナー申請が可能に
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2.4 価値観マッチングの仕組み

**マッチングの目的**: 近い価値観を持つユーザー同士を自動的に結びつける

**スコア計算の基準**: すべて**ユーザープロフィール**を元に数値化

#### 2.4.1 ユーザープロフィールの構成要素

**1. 価値観（バリュー）の選択**

価値観は「お題」と「選択肢」の形式で提示されます。

```
お題の例:
「クリエイターの権利について、あなたの考えは？」

選択肢（複数選択可能）:
☑ クリエイターの権利を最優先すべき
☑ クリエイターと利用者のバランスが重要
□ 利用者の利便性を優先すべき
□ 分からない / どちらでもない
```

各価値観の質問全体に**重要ボタン（⭐）**があり、ユーザーが特に重視する価値観にチェックを入れます。

**重要ボタンの意味**:
- この質問は自分にとって特に重要である
- この質問が一致する人とマッチングしやすくなる

**2. 好きな作品の登録**

- 作品タイトル、作者、ジャンル
- Tier評価（Tier 1 / Tier 2 / Tier 3）
- 作品への価値観タグ付け

#### 2.4.2 マッチングスコアの計算式

マッチングスコアは以下の要素から算出されます：

**基本スコア計算**:
```typescript
総合スコア =
  (価値観一致度 × 0.5) +
  (作品一致度 × 0.3) +
  (目的一致度 × 0.2)

ただし、重要マークがある場合は重み付けを変更
```

**1. 価値観一致度（50%）**

```typescript
// 各質問ごとにスコアを計算
質問スコア = {
  // 通常の質問（重要マークなし）
  if (!userA.important && !userB.important) {
    選択肢が1つでも一致 ? 1.0点 : 0点
  }

  // 片方のみ重要マーク
  else if (userA.important XOR userB.important) {
    選択肢が1つでも一致 ? 1.0点 : 0点  // 通常と同じ扱い
  }

  // 両者が重要マーク
  else if (userA.important && userB.important) {
    選択肢が1つでも一致 ? 1.5点 : 0点  // 1.5倍のボーナス！
  }
}

最終価値観スコア = Σ(質問スコア) / 質問数
```

**例**:
```
全3問の場合

ユーザーA:
  質問1「クリエイター保護」⭐重要
    選択: [最優先, バランス]
  質問2「ヘイト発言」⭐重要
    選択: [絶対禁止]
  質問3「表現の自由」
    選択: [制限すべき]

ユーザーB:
  質問1「クリエイター保護」⭐重要
    選択: [最優先]  ← 「最優先」が共通！
  質問2「ヘイト発言」
    選択: [絶対禁止]  ← 片方だけ重要マーク
  質問3「表現の自由」
    選択: [制限すべき]  ← 一致

計算:
質問1: 両者⭐ + 一致 → 1.5点
質問2: 片方⭐ + 一致 → 1.0点
質問3: 両者⭐なし + 一致 → 1.0点

合計: 3.5点 / 3問 = 116.7% → 上限100%に正規化
```

**重要マークの条件**:
- **両者が⭐重要マーク** + **選択肢が1つでも一致** → 1.5倍ボーナス
- **片方のみ⭐重要マーク** → 通常と同じ扱い（ボーナスなし）
- **選択肢が不一致** → ペナルティなし（0点）

**重要な原則**:
> 互いに「この質問は重要だ」と認識している場合のみ、強いマッチングになる**2. 作品一致度（30%）**

```typescript
作品スコア =
  (共通作品数 / ユーザーの登録作品数の平均) × 100

// 同じTier評価なら加算
Tier一致ボーナス = 同じTierの共通作品数 × 10%
```

**例**:
```
ユーザーA: 作品10個登録
ユーザーB: 作品20個登録

共通作品: 5個（そのうち3個が同じTier評価）

作品スコア = (5 / 15) × 100 = 33.3%
Tierボーナス = 3 × 10% = 30%
最終作品スコア = 33.3% + 30% = 63.3%
```

**3. 目的一致度（20%）**

```typescript
目的スコア = 同じ目的を持つ場合 100%、異なる場合 0%

目的の例:
- 仕事（副業、転職、スキルアップ）
- 遊び（趣味、交流、情報交換）
- 婚活（出会い、恋愛、結婚）
```

#### 2.4.3 重要マークの効果

**重要マーク（⭐）の役割**:
1. **マッチング精度の向上**: 重要な価値観が一致する人を優先的にマッチング
2. **重み付けの強化**: **両者が重要マーク**をつけた質問で選択肢が一致すると1.5倍の重みで計算
3. **片方のみは無効**: 片方だけが重要マークをつけても、ボーナスはなし

```typescript
// 重要マークの効果判定
if (userA.important && userB.important) {
  // 両者が重要視している質問
  if (選択肢が1つでも一致) {
    score += 1.5; // 通常の1.5倍のボーナス
  } else {
    score += 0; // 不一致でもペナルティなし
  }
} else {
  // 片方のみ、または両方とも重要マークなし
  if (選択肢が1つでも一致) {
    score += 1.0; // 通常スコア
  } else {
    score += 0;
  }
}
```

**実際の例**:
```
ケース1: 両者が「クリエイター保護」を⭐重要視 + 選択肢一致
→ スコア +1.5点（通常の1.5倍！）

ケース2: 両者が「ヘイト発言」を⭐重要視 + 選択肢不一致
→ スコア 0点（ペナルティなし、ボーナスなし）

ケース3: 片方だけが「表現の自由」を⭐重要視 + 選択肢一致
→ スコア +1.0点（通常と同じ）

ケース4: 両方とも重要マークなし + 選択肢一致
→ スコア +1.0点（通常スコア）
```

**重要な設計思想**:
> 「この価値観は重要だ」という認識が**互いに**一致している場合のみ、強いマッチングになる。
>
> 片方だけが重要視していても、相手が重要視していなければ、それは「互いに重要な価値観」ではない。

#### 2.4.4 マッチング閾値の考え方

**マッチング要素**:
1. **価値観の一致度**: 回答内容を点数化し、スコア/ランクで表示
2. **Tier評価**: ユーザーが作品に付与したTier 1/2/3評価
3. **目的の一致**: 仕事、遊び、婚活などの目的設定
4. **重要価値観**: 重要マーク付き価値観の一致度
5. **マッチング閾値**: ユーザーが設定した許容範囲

**マッチング閾値の考え方**:
```
【少しでも関係があればOK】
- 閾値: 低（例: 50%以上で一致）
- 結果: グループが組みやすい、人数増加が速い
- 例: 「クリエイター保護」だけ重視
- 重要マーク: 1-2個

【多くの条件が必要】
- 閾値: 高（例: 80%以上で一致）
- 結果: 人数が増えにくい、厳選されたメンバー
- 例: 「クリエイター保護」「幸福追求権」「ヘイト禁止」すべて必須
- 重要マーク: 5個以上
```

**マッチング頻度**:
- 1日1回：無料
- 2回目以降：ポイント（$$）消費

#### 2.4.5 マッチング方式の違い

| 方式 | 対象グループ | プロセス | リーダーの作業 |
|------|-------------|----------|---------------|
| **自動マッチング** | 自動グループ | システムが価値観・作品・重要マークを計算<br>→ 条件を満たせば自動追加 | なし（自動） |
| **手動マッチング** | 手動グループ | システムがスコアを計算<br>→ リーダーが**価値観・作品・重要マークを目で判断**<br>→ 手動承認 | プロフィール確認<br>価値観チェック<br>作品チェック<br>承認判断 |

**手動マッチングでの表示例**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
候補ユーザー: 田中太郎
━━━━━━━━━━━━━━━━━━━━━━━━━━━

総合マッチングスコア: 87%

【価値観一致度】 116% → 100%（上限補正）
✅ クリエイター保護 ⭐⭐
   あなた: [最優先, バランス]
   相手: [最優先]
   → 両者が重要視 + 一致 → +1.5点

✅ ヘイト発言 ⭐
   あなた: [絶対禁止] ⭐
   相手: [絶対禁止]
   → 片方のみ重要視 + 一致 → +1.0点

✅ 表現の自由
   あなた: [制限すべき]
   相手: [制限すべき]
   → 重要マークなし + 一致 → +1.0点

合計: 3.5点 / 3問 = 116.7%

【好きな作品】
共通作品: 5個
- 「進撃の巨人」Tier 1 ✅
- 「鬼滅の刃」Tier 2 ✅
- 「ワンピース」Tier 1 ⚠️（あなた: Tier 2）

【目的】
✅ 仕事（スキルアップ）

━━━━━━━━━━━━━━━━━━━━━━━━━━━
凡例:
⭐⭐ = 両者が重要視（1.5倍ボーナス）
⭐   = 片方のみ重要視（通常スコア）
━━━━━━━━━━━━━━━━━━━━━━━━━━━
[承認する] [ウォッチに追加] [スキップ]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2.5 グループ参加の2段階プロセス

**重要原則**: グループ参加は**人間の意志**を尊重する2段階プロセス

#### 2.5.1 自動グループの場合

```
【完全自動化フロー】
1. システムが価値観の近い人を自動検出
   ・ユーザープロフィールベースで自動計算
   ↓
2. マッチング閾値を満たすかチェック
   ・閾値設定: 少しでもOK or 多くの条件必要
   ↓
3. 自動マッチング
   ・フォロー申請 → 自動フォローバック
   ・即座に正式メンバー
```

**自動マッチングの対象者**:
```
【メンバーのみ希望の人】
✅ ユーザープロフィール作成時に「メンバーのみ」を選択
✅ リーダーをやめて「メンバーのみ」に切り替えた人
✅ ドリフト状態から自動マッチングで復帰する人
→ 最小単位グループのメンバーとして配置
→ リーダー選挙の候補にはならない

【リーダー希望の人】
✅ ユーザープロフィール作成時に「リーダーになる」を選択
✅ 自分のグループを持つ
✅ リーダー選挙の候補になる
```
3. 条件を満たせば自動でグループ追加
   ↓
4. 通知がユーザーに届く
   「〇〇グループに参加しました」
   ↓
5. ユーザーの選択
   ・そのまま参加 → 継続
   ・自主リーブ → 離脱
```

**リーダーの関与**: なし（すべて自動）

#### 2.5.2 手動グループの場合

```
【人間の目で判断フロー】
1. リーダーがマッチング検索
   ・システムがスコア計算して候補表示
   ↓
2. リーダーがユーザープロフィールを目視確認
   ・プロフィール詳細
   ・価値観の回答
   ・過去の投稿/作品
   ↓
3. リーダーの判断
   【第1段階：観察】
   ウォッチ（Watch）
   - 相手のグループを観察する
   - 公開情報のみ閲覧可能

   【第2段階：決意】
   フォロー申請（Follow Request）
   - そのグループに入る決意を示す
   - リーダーの承認待ち状態

   【ショートカット】
   最初からフォロー
   - ウォッチを飛ばして直接フォロー申請も可能
   ↓
4. リーダーが個別に承認判断
   ↓
5. 承認 → 正式メンバー
```

**リーダーの関与**: **すべてのステップで人間の目で判断**

### 2.6 人数バランスの考え方

**重要**: VNSでは**価値観の一致を人数バランスより優先**します。

- グループによって人数に偏りが生じる（これは自然な結果）
- AIが価値観対立グループを自動調整し、安全なオアシスを維持
- 人数均等化ではなく、価値観の純度を保つことを優先

---

## 3. 階層構造と自動スケーリング

### 3.1 階層構造の全体像

```
観測可能な宇宙（Observable Universe）
  ↑
超銀河団（Supercluster）
  ↑
局所銀河群（Local Group）
  ↑
銀河（Galaxy）
  ↑
星団（Star Cluster）
  ↑
太陽系（Solar System）
  ↑
ある一つの惑星（an earth）レベル11+
    ↑
大陸連合（Alliance）レベル10（100,000,000人以上）
    ↑
大陸（Continent）レベル9（25,000,000人以上）
    ↑
国家（Country）レベル8（2,500,000人以上）
    ↑
州（State）レベル7（250,000人以上）
    ↑
メトロポリス（Metropolis）レベル6（50,000人以上）
    ↑
市（City）レベル5（5,000人以上）
    ↑
町（Town）レベル4（1,000人以上）
    ↑
村（Village）レベル3（100人以上）
    ↑
コミュニティ（Community）レベル2（50人以上）
    ↑
グループ/ホーム（Group/Home）レベル1（10人以上）
```

### 3.2 50%ルールによる自動スケーリング

**核心的な設計方針**: グループ許容量の50%超過で上位階層へ自動移行

#### 3.2.1 グループ → 村への移行

```
トリガー条件: グループ人数が許容量（10人）の50%超過
↓
実行: 6人以上になったら自動で「村（Village）」に昇格
```

**移行時の構造**:
- **村のリーダー**: グループのリーダーAが兼任
- **グループのリーダー**: リーダーA（継続）
- **メンバー**: グループにとどまる（村には所属しない）
- **結果**: 村 = リーダーAのみ、グループ = リーダーA + メンバー最大9人

#### 3.2.2 村 → 町への移行

```
トリガー条件: 村の許容量（10グループリーダー）の50%超過
↓
実行: 6グループリーダー以上になったら昇格の機会
```

**リーダー選出フロー（人間の意志を尊重）**:

```
【パターンA: 立候補あり】
1. 立候補期間（例: 7日間）
   ・リーダーになりたい人が自発的に立候補
   ・「リーダー設定: 無効」の人は候補に入らない
   ↓
2-a. 立候補者1人 → その人が自動的に町のリーダーに
2-b. 立候補者複数 → 選挙実施
   ↓
3. 当選者が新階層のリーダーに

【パターンB: 立候補なし】
1. 立候補期間終了、候補者0人
   ↓
2. 選択肢の提示
   【選択肢1】このまま村のまま人数制限オーバーで続ける
   【選択肢2】独立して別々の村に分かれる
   ↓
3. メンバー投票で決定
```

**リーダー候補の条件**:
```
✅ ユーザープロフィール設定で「リーダー資格: 有効」
✅ 自発的に立候補する意志がある
✅ その階層のリーダーとしての責任を負う覚悟

❌ 「リーダー資格: 無効」の人は自動的に候補外
❌ メンバーのみ希望の人は候補外
```
   ・村を構成するグループリーダーたちが投票
   ・得票数が最も多い候補者が町のリーダーに
   ・選挙を拒否する人は独立可能

【パターンB: 立候補ゼロ】
1. 昇格しない（現在の階層で活動継続）
2. 人数が増え続ける
   ↓
3. 上限到達（10グループリーダー）
   ↓
4. それ以上その階層の集まりに入れなくなる
   ↓
5. **新しいメンバーは別の村に自動振り分け**
   ↓
6. 統廃合により村が分裂（システムが自動実行）
```

**重要**: 選挙は**リーダーになりたい人がその集まりでの代表者を決めるもの**

**自動化される要素**:
- 立候補期間の管理
- 投票システム
- 結果集計
- 上限到達時の新規メンバー振り分け
- 統廃合の実行

**移行時の構造**:
- **町のリーダー**: 選挙で選ばれたリーダーB（自分の村のリーダーも兼任）
- **村の構成**: グループリーダーA, B, C, D, E, F...（Bが代表）
- **グループ構成**: 各リーダー配下のメンバーは各グループにとどまる

### 3.3 リーダー兼任システム

**重要**: 選ばれたリーダーのみが上位階層を兼任

```
[例: リーダーAの場合]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🌍 町リーダー（Town - レベル4）
   └─ 6つの村を統括
🏘️ 村リーダー（Village - レベル3）
   └─ 6つのグループを統括
🏠 グループリーダー（Group - レベル1）
   └─ 10人のメンバーを管理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**実際の所属**:
- **グループメンバー**: グループにのみ所属
- **村のリーダーたち**: 各自のグループを管理しつつ、村の構成員
- **町のリーダー（A）**: 町の代表として上位階層に接続

---

## 4. システムグループ（トップダウン形式）

### 4.1 オアシス宣言グループ

**特徴**:
- システムが用意する特別なグループ
- 人数上限なし（誰でも参加可能）
- リーダーは管理人（Admin）

**参加条件**:
- オアシス宣言を守ること（1つのみ）

**ペナルティ制度**:
- 注意、警告、イエローカード、レッドカード、フリーズ、ドリフト

### 4.2 人間宣言グループ

**特徴**:
- システムが用意する特別なグループ
- 人数上限なし（誰でも参加可能）
- リーダーは管理人（Admin）

**参加条件**:
- 人間宣言を守ること（1つのみ）

**ペナルティ制度**:
- 注意、警告、イエローカード、レッドカード、フリーズ、ドリフト

---

## 5. ロールと権限（RBAC）

### 5.1 リーダーの権限と責任の原則

**VNSの根本原則**: リーダーは**すべての責任を負う代わりに、すべての権限を持つ**

- リーダーが独裁制を選択しようと、共和制を選択しようと、すべてリーダーが背負う
- 価値観サイトでは価値観が近い人同士なので、嫌いなら離れてもらうのはリーダーの意見が優先
- メンバーはユーザーの意志一つで自由にどこでも移動可能（土地に縛られない）
- リーダーも気に入らない人を自由にリーブさせることが可能

### 5.2 役割の定義

| 役割 | 概要 | 主な権限 | 責任 |
|------|------|----------|------|
| **グループのリーダー** | グループのすべてを背負う者 | ・グループ情報の編集<br>・メンバー管理（追加/削除）<br>・ペナルティ付与（すべての段階）<br>・強制リーブの実行<br>・上位階層への参加申請 | **メンバーの発言に対する責任**<br>・独裁/共和の選択責任<br>・グループ運営のすべて |
| **マネージャー** | リーダー権限の一部を代行 | ・メンバー追加<br>・メンバー削除 | ・代行権限の範囲で責任を負う |
| **グループのメンバー** | グループの一員 | ・投稿/コメント<br>・リーダーの評価<br>・作品の閲覧<br>・自主リーブ（自由な離脱） | ・自分の発言に対する責任<br>（最終責任はリーダー） |
| **認証済みユーザー** | ログイン済みユーザー | ・ルートアカウント管理<br>・プロフィール作成/管理<br>・作品の登録/評価<br>・グループ移動（自由） | ・自分のアカウントに対する責任 |
| **管理人（Admin）** | システム運営者 | ・全ユーザーアカウント管理<br>・システム設定変更<br>・全ログへのアクセス | ・システム全体の安全性確保 |

---

## 6. メンバー管理

### 6.1 メンバーになる条件

```
【ユーザープロフィール同士のマッチング】
価値観の近い人同士を結びつける

1. ユーザープロフィールのマッチング
   ・ベーシック価値観の回答必須
   ・価値観スコア/ランクで相性表示
   ↓
2. ウォッチ（観察）- 第1段階
   ・相手のグループを観察
   ・公開情報の閲覧
   ・まだコミットしていない
   ↓
3. フォロー（参加申請）- 第2段階
   ・グループに入る決意を示す
   ・最初からフォローも可能（ウォッチ省略）
   ↓
4. 承認プロセス
   ・自動グループ：条件を満たせば自動承認
   ・手動グループ：リーダーが個別承認
   ↓
5. 相互フォロー状態 = 正式メンバー
```

### 6.2 関係性の定義

#### 6.2.1 基本的な関係（グループ参加関連）

| 関係 | 説明 | 権限 | 人間の意志 | リーダー経験 |
|------|------|------|-----------|-------------|
| **ウォッチ** | グループを観察 | 公開情報の閲覧のみ | 相手を選ぶ第1段階 | 不要 |
| **フォロー** | グループに参加申請 | 参加申請中（承認待ち） | 入る決意を示す第2段階 | 不要 |
| **フォローバック** | 申込みを承諾 | 互いにフォロー（相互フォロー状態） | リーダーの意志 | 不要 |
| **相互フォロー** | 互いにフォロー | グループメンバーとして参加 | 両者の合意 | 不要 |

#### 6.2.2 深い関係（プロフィール目的に応じた1対1の関係）

**重要**: プレパートナー・パートナー関係は**リーダー経験が必須**です。リーダー経験は責任を負う覚悟の証明となります。

| 関係 | 説明 | 権限 | 人間の意志 | リーダー経験 |
|------|------|------|-----------|-------------|
| **プレパートナー** | より深い関係の候補<br>・婚活プロフィール: 婚活候補<br>・ビジネスプロフィール: パートナー候補<br>・趣味プロフィール: 深い交流候補 | ・プライベートメッセージ交換<br>・限定情報の共有<br>・1対1の深い交流 | 一方が申請<br>↓<br>相手が承認<br>↓<br>プレパートナー成立 | **必須** |
| **パートナー** | 最も深い関係<br>・婚活プロフィール: 婚活相手（結婚相手・恋人）<br>・ビジネスプロフィール: ビジネスパートナー<br>・趣味プロフィール: 親友・相棒 | ・プレパートナーの全権限<br>・共同プロフィール機能（予定）<br>・カップルグループ作成（予定） | プレパートナー関係から<br>一方が申請<br>↓<br>相手が承認<br>↓<br>パートナー成立 | **必須** |

**プロフィール目的別の意味**:

```
【婚活プロフィールの場合】
プレパートナー = 婚活候補（お見合い相手、交際候補）
パートナー = 婚活相手（結婚相手、恋人）

【ビジネスプロフィールの場合】
プレパートナー = ビジネスパートナー候補（協業候補）
パートナー = ビジネスパートナー（正式な協業相手）

【趣味プロフィールの場合】
プレパートナー = 深い交流候補（一緒に活動する候補）
パートナー = 親友・相棒（最も信頼できる仲間）

【学習・スキルアッププロフィールの場合】
プレパートナー = 学習パートナー候補
パートナー = 学習パートナー（切磋琢磨する相手）
```

**申請・承認ワークフロー**:

```
【プレパートナー申請】
1. ユーザーAがユーザーBにプレパートナー申請
   ・条件: 両者ともリーダー経験あり
   ・申請時にメッセージ送信可能
   ↓
2. ユーザーBが承認 or 拒否
   ・承認 → プレパートナー成立
   ・拒否 → 申請却下（再申請は一定期間後に可能）
   ↓
3. プレパートナー関係開始
   ・プライベートメッセージ交換可能
   ・限定情報の共有
   ・1対1の深い交流

【パートナー申請】
前提: プレパートナー関係が成立していること

1. ユーザーAがユーザーBにパートナー申請
   ・プレパートナー期間: 制限なし（両者が準備できたタイミング）
   ・申請時にメッセージ送信可能
   ↓
2. ユーザーBが承認 or 拒否
   ・承認 → パートナー成立
   ・拒否 → プレパートナー関係は継続
   ↓
3. パートナー関係開始
   ・最も深い関係として記録
   ・共同プロフィール機能（今後実装予定）
   ・カップルグループ作成（今後実装予定）
```

### 6.3 メンバーの離脱（リーブ）

**VNSの重要原則**: 現実の土地のように縛られず、ユーザーの意志一つで自由に移動可能

| 離脱タイプ | 説明 | 実行者 | 状態 |
|----------|------|--------|------|
| **自主リーブ** | メンバーが自分の意志で離脱 | メンバー本人 | **ドリフト状態**（次の選択肢へ） |
| **強制リーブ（追放）** | リーダーがメンバーを離脱させる | リーダー | **ドリフト状態**（次の選択肢へ） |

**リーバー共通の注意点**:
- グループから離れると**ドリフト状態**になる
- ドリフト状態 = どこにも所属していない、リーダーもしていない状態
- ドリフターは次の行動を選択できる

**リーダーの権限**:
- 気に入らない人を自由にリーブさせることが可能
- 価値観が近い人同士のグループなので、嫌いなら離れてもらうのはリーダーの意見が優先
- リーダーがすべての責任を負う代わりに、すべての権限を持つ

### 6.4 ドリフト状態とドリフター

**ドリフト**: グループから離れた（追放された/自分から離れた）ことで、どこにも所属していない孤立状態

**ドリフター**: ドリフト状態になった人

#### 6.4.1 ドリフト状態になるケース

1. **強制リーブ（追放）** - リーダーに追放された
2. **自主リーブ** - 自分からグループを離れた
3. **フリーズ期間終了後** - ペナルティ期間が終了し、自動的にドリフト状態になる

#### 6.4.2 ドリフト状態での選択肢

ドリフターは以下の選択肢から自由に選べます：

```
【選択肢1】自動マッチングで参加（推奨）
→ 定期的な自動マッチングチェックで価値観の合うグループに自動参加

【選択肢2】一人のグループのリーダーに戻る
→ 自分で新しいグループを作成してリーダーになる
→ ただし、リーダーに復帰すると決めなければならない

【選択肢3】手動でウォッチ・フォロー
→ 自分でグループを探してウォッチ
→ 気に入ったらフォロー申請
→ リーダーが承認すればメンバーになる
```

#### 6.4.3 自動マッチングによる復帰（推奨フロー）

```
【自動復帰フロー】
1. ドリフト状態になる
   ↓
2. システムが定期的に自動マッチングをチェック
   ・ユーザープロフィールベースで価値観を計算
   ・マッチング閾値を満たすグループを検索
   ↓
3. 条件を満たすグループが見つかる
   ・リーダーが「自動マッチング」を選択している
   ・価値観スコアが閾値を超えている
   ↓
4. 自動的にグループに参加
   ・フォロー申請 → 自動フォローバック
   ・即座に相互フォロー状態（正式メンバー）
   ↓
5. 通知が届く
   「〇〇グループに参加しました」
```

**自動マッチングの頻度**:
- ドリフター: 1日1回自動チェック（無料）
- 手動で再チェック: ポイント消費

#### 6.4.4 リーダー復帰の選択

**リーダーに復帰する場合**:
```
1. ドリフト状態で「リーダーに復帰」を選択
   ↓
2. 新しいグループ（一人グループ）が作成される
   ↓
3. メンバー募集方法を選択
   【自動マッチング】
   - すべて自動でメンバーが集まる
   - リーダーは何もしなくて良い

   【手動マッチング】
   - フォロー申請を一つずつ確認
   - リーダーが承認/拒否を判断
```

**重要**: リーダーに復帰すると決めなければならない（責任を伴う）

#### 6.4.5 リーダーの途中辞任

**すでにリーダーをしているが、リーダーをやめたい場合**:

```
1. リーダー辞任を申請
   ↓
2. 後任リーダーの選出
   【候補者がいる場合】
   ・立候補者 → 選挙
   ・当選者が新リーダーに
   ・元リーダーは平メンバーに

   【候補者がいない場合】
   ・グループを畳む選択肢
   ・全メンバーをドリフト状態に
   ↓
3. 辞任後の選択
   【選択肢1】そのグループにメンバーとして残る
   【選択肢2】自動マッチングで他のグループへ
   【選択肢3】手動で他のグループへ
```

**リーダー設定の変更**:
```
ユーザープロフィール設定:
- リーダー資格: [有効] / [無効]

[無効]を選択すると:
✅ メンバーとしての活動は継続
❌ リーダー選挙の候補にならない
❌ 上位階層のリーダー候補にならない
❌ 後任リーダーの候補にならない
```

**リーダー設定とグループ成長の関係**:
```
【リーダー設定を調整する理由】
- メンバーを集めやすくする
  → 閾値を下げる（50%など）
  → 自動マッチング範囲を広げる

- グループを大きくしない
  → 閾値を上げる（80%など）
  → 厳選されたメンバーのみ

- グループ成長の速度調整
  → リーダーの頑張り次第
  → 設定変更で柔軟に対応
```

---

## 7. ペナルティシステム

### 7.1 ペナルティの基本原則

**リーダーの絶対的権限**: リーダーがすべての責任を負う代わりに、ペナルティの判断・実行もすべてリーダーが行う

- リーダーが独裁制を選ぼうと、共和制を選ぼうと、最終責任はリーダー
- 価値観が近い人同士なので、嫌いなら離れてもらうのはリーダーの意見が優先
- メンバーは自由に移動可能、リーダーも自由にメンバーをリーブさせられる
- **権限の濫用もリーダーの責任**（評判システムで自然淘汰）

### 7.2 ペナルティの種類

| ペナルティ | 単位 | 説明 | 累積効果 | 実行者 |
|-----------|------|------|---------|--------|
| **注意** | ユーザープロフィール単位 | 最小の処罰（記録のみ） | なし | リーダー |
| **警告** | ユーザープロフィール単位 | 注意より重い | 警告2回 → イエローカード | リーダー |
| **イエローカード** | ユーザープロフィール単位 | 警告より重い | イエローカード2枚 → レッドカード | リーダー |
| **レッドカード** | ユーザープロフィール単位 | イエローカードより重い | レッドカード2枚 → フリーズ | リーダー |
| **フリーズ** | ユーザープロフィール単位 | **処罰期間**（機能制限） | 期間終了後 → **ドリフト状態** | リーダー |
| **強制リーブ（追放）** | - | リーダーがメンバーを離脱させる | **ドリフト状態**になる | リーダー |
| **自主リーブ** | - | メンバーが自分で離脱 | **ドリフト状態**になる | メンバー本人 |
| **ミュート** | ルートアカウント単位 | 特定ユーザーを見えなくする | 発言/プロフィール非表示、マッチング除外<br>**相手には通知されない** | 各ユーザー |
| **アナザーディメンション** | ルートアカウント単位 | 完全な関係断絶 | 二度と会えない（別次元に移動） | 各ユーザー |

### 7.3 フリーズ状態の詳細

**フリーズ**: 注意・警告・カードの累積が一定数以上に達した場合に発動する**処罰期間**

**フリーズの本質**:
- フリーズは**処罰期間**である
- ペナルティの重さによって処罰期間が変わる
- 処罰期間が終了すると自動的に**ドリフト状態**になる

**フリーズはグループ単位で適用**:
```
例: ユーザープロフィールAが3つのグループに所属

グループ1: フリーズ中（処罰期間）
  ❌ 書き込み不可
  ❌ コメント不可
  ✅ ウォッチのみ可能

グループ2: 正常（フリーズなし）
  ✅ すべての活動が可能
  ✅ 書き込み可能
  ✅ コメント可能

グループ3: 正常（フリーズなし）
  ✅ すべての活動が可能
```

**重要**: フリーズは特定のグループでの処罰であり、他のグループでの活動には影響しない

**フリーズ時の制限（対象グループのみ）**:
- ❌ マッチング不可（そのグループ）
- ❌ 書き込み不可（そのグループ）
- ❌ コメント不可（そのグループ）
- ❌ フォロー申請不可（そのグループ）
- ✅ **ウォッチのみ可能**（観察はできる）

**フリーズ期間とペナルティの重さ**:
```
軽度のペナルティ: フリーズ期間 3日
中度のペナルティ: フリーズ期間 7日
重度のペナルティ: フリーズ期間 30日
極度のペナルティ: フリーズ期間 90日
```

**フリーズ終了後のフロー（そのグループでの）**:
```
1. フリーズ期間終了
   ↓
2. 自動的に**そのグループから離脱**（強制リーブ）
   ↓
3. そのグループの状態が「フリーズ解除 → 離脱済み」になる
   ↓
4. 【重要】他のグループに所属していない + リーダーでもない場合
   → ドリフト状態になる
```

**ユーザープロフィール管理画面での表示**:
```
マイグループ一覧:
- グループ1: フリーズ中（残り3日） ⚠️
- グループ2: 正常 ✅
- グループ3: 正常 ✅
```

### 7.4 ドリフト状態の詳細

**ドリフト**: **どのグループのメンバーにもなっていなくて**、**リーダーもしていない**状態

**ドリフター**: ドリフト状態になった人

**ドリフト状態になるケース**:
1. 強制リーブ（追放）された **かつ** 他にグループ所属がない **かつ** リーダーでもない
2. 自主リーブした **かつ** 他にグループ所属がない **かつ** リーダーでもない
3. **フリーズ期間が終了し強制離脱した** **かつ** 他にグループ所属がない **かつ** リーダーでもない

**ドリフト判定の条件（すべて満たす必要がある）**:
```
✅ 所属グループ数 = 0
✅ リーダーになっているグループ数 = 0
✅ フォロー申請中のグループ数 = 0
→ ドリフト状態
```

**ドリフト状態にならない例**:
```
例1: グループAでフリーズされたが、グループBには正常に所属
→ ドリフト状態にはならない（グループBで活動継続）

例2: すべてのグループを離脱したが、自分のグループのリーダーをしている
→ ドリフト状態にはならない（リーダーとして活動継続）

例3: 10グループのうち9つを離脱し、1つだけ所属中
→ ドリフト状態にはならない（1つでも所属していればOK）
```

**ドリフト状態での行動**:
- ✅ 自動マッチングで自動復帰（定期チェック）
- ✅ 新しいグループを自分で作成可能（リーダー復帰）
- ✅ 既存のグループにウォッチ・フォロー申請可能
- ❌ グループ活動はできない（所属していないため）

**重要な仕組み**:
> ドリフターは定期的に自動マッチングがチェックされる
>
> 価値観の合うグループが見つかれば自動的に参加できる
>
> リーダーが「自動マッチング」を選択していれば、フォロー申請は自動承認される

**自動マッチングからドリフト復帰までのフロー**:
```
1. ドリフト状態になる
   ・すべてのグループから離脱
   ・リーダーでもない
   ↓
2. 次の自動マッチング（1日1回）まで待つ
   ・自動マッチングが定期的にチェック
   ・価値観の合うグループを検索
   ↓
3. マッチングしたグループが見つかる
   ・リーダーが「自動マッチング」選択中
   ・価値観スコアが閾値以上
   ↓
4. 自動参加
   ・フォロー申請 → 自動フォローバック
   ・ドリフト状態から脱出
```

### 7.5 権限濫用の自然淘汰

**VNSの自浄作用**: リーダーの権限濫用は評判システムで自然に淘汰される

- 不当なペナルティを乱発するリーダー → メンバーが次々と自主リーブ
- 評判が悪化 → 新しいメンバーが集まらない
- マッチングスコアの低下 → グループが自然消滅

**メンバーの自衛手段**:
- 自主リーブ（いつでも自由に離脱 → ドリフト状態 → 次の選択）
- リーダー評価（低評価でマッチング精度向上）
- ミュート（相手に気づかれずに非表示）
- アナザーディメンション（完全な関係断絶）

### 7.6 応援（フォローの別名）

**応援**: 特定のグループを応援すること = フォローと同じ意味

```
応援する = フォローする = そのグループのメンバーになって応援する
```

**用語の使い分け**:
- **フォロー**: システム用語、正式な名称
- **応援**: ユーザー向けの親しみやすい表現

### 7.7 フォロー申請の上限（10グループ）

**制限の内容**:
```
【申し込み側（メンバー）】
- 1つのユーザープロフィールで最大10グループまで同時に所属可能
- フォロー申請中（ペンディング）: 上限にカウント
- 相互フォロー状態（正式メンバー）: 上限にカウント

【受け入れ側（リーダー）】
- リーダーは制限なし
- 自由にメンバー数を増やせる
- フォローバック（承認）に上限はない
```

**理由**: ユーザーが管理できる範囲を考慮

**複数グループ所属の例**:
```
ユーザープロフィールA:
- グループ1: 正式メンバー
- グループ2: 正式メンバー
- グループ3: フォロー申請中
- ...
- グループ10: 正式メンバー
→ 合計10グループまで所属・申請可能
```

**フォローとフォローバックの関係**:
```
【フォロー】申し込み側
- メンバーがグループに参加申請
- 上限10グループまで（ペンディング + 正式メンバー）

【フォローバック】受け付ける側
- リーダーが申請を承認
- 上限なし（何人でも承認可能）

【相互フォロー状態】
- フォロー + フォローバック = 相互フォロー（正式メンバー）
- この状態も上限10にカウント
```

---

## 8. ルール設定

### 8.1 システム全体のルール（必須）

1. オアシス宣言の遵守
2. ヘイト発言・ネガティブ発言の禁止
3. クリエイターの権利保護
4. 幸福追求権の優先

### 8.2 グループローカルルール（任意）

リーダーが設定できる独自ルール:
- 新規メンバー基準
- ペナルティ基準
- 活動ルール

---

## 9. セキュリティ要件

### 9.1 RLS（Row Level Security）

- データベース層でのデータ保護
- 認証されたユーザーのみが関連情報にアクセス可能
- グループ/メンバーシップ/投稿/コメント/評価テーブルに適用

### 9.2 アプリケーション層での制御

- UIの表示制御（リーダーのみの機能）
- サーバー側での最終検証（Next.js Server Actions）

---

## 10. UI/UX要件

### 10.1 情報公開の原則

**VNSの透明性原則**: 価値観サイトでは基本的に**すべての情報を公開**

**メンバーの階層認識**:
- メンバーは自分のグループがどの階層に属するか知ることができる
- グループ → 村 → 町 → 市... の構造を可視化
- リーダーの兼任状況も表示
- **理由**: 透明性を重視し、全体像を理解した上での参加を促す

### 10.2 ダッシュボード表示（自動グループ）

**最重要**: 複雑なシステムを表に出さず、シンプルな情報のみ表示

**リーダー向け（自動グループ）**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 グループダッシュボード
━━━━━━━━━━━━━━━━━━━━━━━━━━━

現在の人数: 7/10人 ← リアルタイム自動更新
階層レベル: グループ（レベル1）
次の昇格: あと3人で村に自動昇格

統廃合状態: 正常 ✓

━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ あなたの役割
━━━━━━━━━━━━━━━━━━━━━━━━━━━
メンバーの発言の責任を負う
ペナルティの判断のみ実行

その他はすべて自動化されています
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**リーダー向け（手動グループ）**:
- 兼任している階層の一覧
- 各階層のメンバー数/上限
- メンバー承認待ちリスト
- マッチングスコア付き候補リスト
- ペナルティ履歴

**メンバー向け（全グループ共通）**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏠 マイグループ
━━━━━━━━━━━━━━━━━━━━━━━━━━━

グループ名: クリエイター応援団
階層レベル: 村（レベル3）
現在の人数: 123人

上位階層:
村（レベル3）← 今ここ
  ↓
町（レベル4）: 技術系コミュニティ連合
  ↓
市（レベル5）: 関東クリエイター圏

━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 10.3 階層構造の可視化

**シンプル表示（メンバー向け）**:
- **パンくずリスト**: 現在位置の階層パス表示
- **基本統計**: 人数、ポイント倍率のみ
- **複雑な情報は非表示**: 統廃合ロジック、上限管理は隠す

**詳細表示（リーダー向け）**:
- **ツリービュー**: 階層構造を木構造で表示
- **統計情報**: 各階層の詳細データ
- **リーダー兼任表示**: 同一人物が複数階層を管理していることを明示

---

## 11. ゲーム化要素

### 11.1 ポイント倍率システム

| 階層 | レベル | 倍率 |
|------|--------|------|
| グループ | 1 | 1.0 |
| コミュニティ | 2 | 1.7 |
| 村 | 3 | 2.8 |
| 町 | 4 | 4.7 |
| 市 | 5 | 7.8 |

### 11.2 称号システム

- 🏠 グループリーダー
- 🏘️ 村長
- 🏛️ 町長
- 🏙️ 市長

---

## 12. 未解決の課題

### 12.1 要検討事項

- [ ] 自動グループと手動グループの切り替え可否
- [ ] マッチング閾値のデフォルト値（少しでもOK vs 多くの条件）
- [ ] 上限到達時の新規メンバー振り分けアルゴリズム
- [ ] 統廃合時の通知タイミングと内容
- [ ] 立候補期間の適切な長さ（7日？14日？）
- [ ] 独立したグループの再統合ルール（できる？できない？）

---

## 13. 実装の優先度

### 13.1 フェーズ1（必須機能）
- グループ作成、リーダー権限、メンバー管理、基本RLS

### 13.2 フェーズ2（自動スケーリング）
- 50%ルール、階層移動、通知システム

### 13.3 フェーズ3（上位階層管理）
- リーダー選出、ダッシュボード、ルール優先順位

### 13.4 フェーズ4（ゲーム化要素）
- ポイント倍率、称号、可視化

---

## 付録A: 設計判断の記録

### A.1 50%ルールについて
**判断**: 50%閾値を採用
- **理由**: 過度な膨張を防ぎ、価値観の純度を保つ
- **懸念**: 頻繁なスケーリングによるリーダー負担
- **対策**: 自動グループでは運営作業を極力自動化

### A.2 リーダー選出方法について
**判断**: 立候補 → 選挙方式を採用
- **理由**: 人間の意志を尊重（強制的なリーダー就任を避ける）
- **利点**: やる気のある人がリーダーになる
- **懸念**: 立候補者がいない場合の停滞
- **対策**: 昇格せず現状維持、または自動選出のオプション提供

### A.3 メンバーの階層認識について
**判断**: すべての情報を公開する
- **理由**: VNSは透明性を重視する価値観サイト
- **利点**: 全体像を理解した上での参加、信頼性向上
- **懸念**: 階層が上がるほどリーダーとの距離が遠くなる
- **対策**: 各階層のリーダーが責任を持つ分散型管理

### A.4 ペナルティシステムについて
**判断**: リーダーにすべての権限と責任を与える
- **理由**: 価値観が近い人同士なので、自由な管理を認める
- **利点**: リーダーの裁量で柔軟な運営が可能
- **懸念**: 権限濫用の可能性
- **対策**: 自然淘汰（評判システム、自主リーブ、マッチング精度）

### A.5 価値観マッチングについて
**判断**: ユーザープロフィールを元に計算
- **方法**: ベーシック価値観の回答を点数化
- **表示**: スコア/ランク形式で相性を可視化
- **閾値設定**: ユーザーが選択
  - 「少しでも関係があればOK」→ 人数増加速い
  - 「多くの条件が必要」→ 人数増加遅い、厳選
- **AI役割**: 価値観の対立グループを自動調整して分離
- **精度**: 運用しながら学習・改善していく

### A.6 自動化の範囲について
**判断**: 自動グループではメンバーの処分以外すべて自動化
- **理由**: 複雑なシステムをできる限り表に出さない
- **自動化要素**:
  - グループ作成
  - メンバーマッチング・追加
  - 人数カウント表示
  - 階層昇格
  - 統廃合
  - 通知
- **リーダーの役割**: ペナルティ判断のみ
- **利点**: リーダーの負担を最小化、運営のハードルを下げる

### A.7 立候補ゼロ時の対応について
**判断**: 昇格せず現在の階層で活動継続
- **理由**: 強制的なリーダー就任を避ける（人間の意志を尊重）
- **上限到達時**: 新規メンバーを別の集まりに自動振り分け
- **統廃合**: システムが自動実行
- **選挙の目的**: リーダーになりたい人が代表者を決めるもの
- **その他**: すべて自動化で対応


---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|----------|--------|
| 2025-10-10 | 1.0 | 初版作成 | masakinihirota |

---

**このドキュメントは生きたドキュメントです。実装やテスト結果に基づいて随時更新してください。**
