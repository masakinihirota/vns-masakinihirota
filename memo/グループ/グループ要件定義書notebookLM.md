
## Next.jsとSupabaseを用いたRLS/RBACグループ機能要件定義書

### I. はじめに

#### 1.1. 目的
本要件定義の目的は、VNS「masakinihirota」におけるグループ機能（オアシス）を、**クリエイターの保護**と**幸福追求権の優先**という基本原則 に則り、Next.jsおよびSupabaseを用いて安全かつ拡張性高く実装することにあります。特に、ユーザーの役割（ロール）に基づいた厳格なアクセス制御（RBAC）と、データベース層でのデータ保護（RLS）の実現を定義します。

#### 1.2. 採用技術スタック
*   **フロントエンド:** Next.js (App Router), React, TypeScript。
*   **バックエンド/データベース:** Supabase (PostgreSQL, Auth, RLS)。
*   **権限管理:** RLS (Supabase/PostgreSQL) および RBAC。

### II. グループ機能（オアシス）の要件

#### 2.1. グループの基本構造
1.  **グループの作成:** ユーザー認証後、**ユーザープロフィール**を作成した際、そのユーザープロフィールに紐づく**最小グループ**が自動的に作成され、当該ユーザーが自動的に**リーダー**となります。
2.  **グループの規模:** 1グループあたりの人数は制限されます（例: 1～10人）。
3.  **階層構造:** グループ（オアシス）のリーダーは、複数のグループをまとめ、より大きな「**それ以上のまとまり**」（村、町、市など）を階層的に形成できます（ボトムアップ方式）。
4.  **グループルール:** グループには、基本ルールとして**オアシス宣言の遵守**が自動的に適用されます。

#### 2.2. メンバー管理と参加方法
1.  **参加方法:** ユーザーはマッチングを通じて価値観の合う人を見つけ、「ウォッチ」や「フォロー」を選択し、相手がフォローバック（相互フォロー）することでグループメンバーとして追加されます。
2.  **参加単位:** グループに参加する際は、自身の**ユーザープロフィールのみ**が参加します。

### III. セキュリティ要件：RLSとRBACによるアクセス制御

RLSとRBACは、VNSのセキュリティ設計（優先度:高）の核となります。

#### 3.1. RLS（行レベルセキュリティ）の活用
SupabaseのコアであるPostgreSQLの機能としてRLSを最大限に活用します。

1.  **データアクセス制御:** RLSにより、認証されたユーザーが「**自分に関係のある情報や、見ることを許された情報だけ**」に触れるようにデータベース自身が賢く制御します。
2.  **開発の簡素化:** 複雑な情報の流れもRLSによってデータベース側で制御されるため、アプリケーション開発がシンプルになります。
3.  **実装場所:** RLSはデータアクセスに利用されます 。

#### 3.2. RBAC（ロールベースアクセス制御）の定義

RBACは、グループ内およびシステム全体でのユーザーの**役割**に応じて、実行可能な「力（権限）」を定義します。

| 役割（ロール） | 概要と立ち位置 | 主な権限（力）と責務 | 関連する技術的要素 |
| :--- | :--- | :--- | :--- |
| **グループのリーダー** | グループ（オアシス）のすべての責任を負う者。 | グループ情報の編集（名前、ルール）。**仲間の招待、承認、別れを告げること（メンバー管理）**。メンバーに対する**ペナルティ（警告、リーブ、アナザーディメンションなど）を課す全権限**。 | Next.js Server Actionsによる最終検証。グループテーブルでのRLSポリシー。 |
| **マネージャー** | リーダー権限の一部を代行する者。 | メンバーの追加、メンバーを外す（除名）。 | リーダー権限の**移譲は不可**（重要権限を除く一部移譲は可能）。 |
| **グループのメンバー** | グループの一員で、リーダーとウォッチ以上の関係にある者。 | 自身の投稿、作品の表現（投稿、編集、削除）。仲間の言葉や作品の閲覧。**リーダーを評価**すること。 | RLSにより、グループ内の情報アクセスを制限。 |
| **認証済みユーザー** | ログインし、ルートアカウントを持つユーザー。 | 自身のルートアカウントおよびユーザープロフィールの作成・管理。作品の登録・評価。 | ルートアカウントID、所持ポイント（一元管理）。 |
| **管理人 (Admin)** | 世界全体を見守り維持する運営側の役割。 | すべてのユーザーアカウントの管理、システム設定の変更、不適切な行為の監視、**すべてのログと情報へのアクセス**。 | AdminUsersテーブル。管理者ダッシュボード (`/admin` ルート)。 |

#### 3.3. Next.jsアプリケーション層での制御

データベース層のRLSに加え、アプリケーション層でもセキュリティを確保します。

1.  **UIの表示制御:** リーダーのみに表示すべき機能（例：メンバー追加/削除ボタン、グループルール設定メニュー）は、ユーザーの役割情報を確認した上で、**クライアント側（Next.js/React）で出し分け**ます。
2.  **サーバー側での最終検証:** ユーザーがアクション（例：メンバー削除）を試みた際、**Next.jsのServer Actions**などのサーバー側ロジックで、そのユーザーがデータベース上の正式なリーダーであるかを再度検証し、クライアントの改ざんを防ぎます。

### IV. システム実装の具体的な要素

#### 4.1. 認証と役割連携
*   **認証方式:** OAuth認証（Google、GitHub等）を利用したアカウント作成・ログイン機能を採用します。
*   **権限付与:** 権限とアクセス制御には、SupabaseのRLSを活用した**RBAC（ロールベースアクセス制御）**が原則となります。
*   **ルートアカウント:** 認証済みユーザーにはシステム全体で一意の「ルートアカウント」が1つ付与され、ポイントなどのリソースを一元管理します。ユーザープロフィールはこのルートアカウントのポイントに依存します。

#### 4.2. 開発環境とテスト
*   **開発/テスト環境:** Supabaseの「プレビュー環境」や「開発環境」機能、およびテスト専用のデータベースを活用することが推奨されます。
*   **セキュリティテスト:** RLSによるアクセス制御が有効かを確認するため、セキュリティテストを実施します。特に「**他の人の情報が勝手に見えてしまわないか？**」といった脆弱性を確認することが重要です。



----------------------------------------

1. **価値観ベースの自動マッチング**: 人数バランスより価値観の一致を優先

1.1 基本原則
- **幸福追求権の優先**: 表現の自由より幸福追求権を優先（日本国憲法第13条 > 第21条）
- **クリエイター保護**: コンテンツ創造者の権利と利益を最優先
- **ヘイト発言等の禁止**: ネガティブな発言やヘイトスピーチは禁止
- **ボトムアップ方式**: 少数のグループから拡大していく構造
- **価値観の一致**: マッチングの基本は価値観、対立するグループは自動調整で分離









