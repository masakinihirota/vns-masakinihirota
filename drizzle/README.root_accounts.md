3つのテーブル間の関係
責務分離の観点から設計を深く分析

## **テーブルの責務と関係性の整理**

### **各テーブルの責務**

```
auth.users (Supabase内部管理)
├── 認証システム専用データ
├── Supabase内部でのみ直接操作
└── アプリケーション側からは参照のみ

public.auth_users (認証データ専用)
├── auth.usersのミラーリング
├── 認証関連メタデータの管理
├── セッション情報・ログイン履歴
└── セキュリティ関連の状態管理

public.root_accounts (アプリケーション機能専用)
├── ユーザープロフィール・設定
├── ビジネスロジック関連データ
├── アプリケーション固有の機能
└── UI表示に必要な情報
```

## **推奨する関係設計**

### **パターン: チェーン型関係（推奨）**

```
auth.users
    ↓ 1:1 (id参照)
public.auth_users
    ↓ 1:1 (外部キー)
public.root_accounts
```

**設計理由:**

1. **責務の明確な分離**: 各テーブルが明確に異なる責務を持つ
2. **データ整合性**: 外部キー制約により厳密な関係を保証
3. **スケーラビリティ**: 各層を独立してスケール可能
4. **保守性**: 認証とアプリ機能を分離してメンテナンス可能

## **なぜこの設計が最適か**

### **1. データの流れが自然**

```
認証イベント → auth.users → auth_users → root_accounts
```

- データの変更が一方向に流れ、循環参照を回避
- 各段階でのデータ変換・検証が可能

### **2. 失敗時の影響範囲が限定的**
- `auth_users`の同期失敗 → `root_accounts`に影響なし
- `root_accounts`の問題 → 認証システムに影響なし

### **3. 将来的な拡張性**
- 認証プロバイダーの変更時: `auth_users`のみ変更
- アプリ機能追加時: `root_accounts`のみ変更
- マルチテナント対応: `root_accounts`に`tenant_id`追加

### **4. パフォーマンス最適化**
- 認証チェック: `auth_users`のみアクセス
- プロフィール表示: `root_accounts`のみアクセス
- 必要時のみJOIN実行

## **データ同期戦略**

### **Database Function + Trigger**

## **Tips とアドバイス**

### **開発効率化**
- **View作成**: 頻繁なJOINクエリ用に`user_profile_view`を作成
- **インデックス最適化**: `root_accounts.auth_user_id`にインデックス作成
- **型安全性**: Drizzle ORMの関係定義でコンパイル時チェック

### **運用監視**
- **同期監視**: `auth_users`と`root_accounts`の数の整合性チェック
- **パフォーマンス**: JOIN操作の実行計画監視
- **データ品質**: 孤児レコード（orphaned records）の定期チェック

### **セキュリティ強化**
- **最小権限**: 各テーブルに必要最小限のRLSポリシー
- **監査ログ**: 重要な変更操作のログ記録
- **暗号化**: 機密データの適切な暗号化

この設計により、責務分離を保ちながら、データの整合性とパフォーマンスを両立できる堅牢なアーキテクチャが実現できます。
