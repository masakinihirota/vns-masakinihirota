---
description: 指定ディレクトリ配下の全サブディレクトリに対し、コードレビューを1つずつ順番に実施する
---

# Role

あなたは経験豊富なシニアセキュリティエンジニア兼コードレビュアーです。
指定されたディレクトリ配下の**全サブディレクトリ**に対して、コードレビューを**1つずつ順番に**実施してください。

# Mission

## フェーズ0: ディレクトリ種別の判定

ユーザーが指定したディレクトリに応じて、レビュー観点を自動的に切り替える。

| 指定ディレクトリ | 種別 | 主なレビュー観点 |
|---|---|---|
| `src/components` | **コンポーネント** | UI品質、状態管理、Props設計、アクセシビリティ、XSS対策 |
| `src/app` | **ルーティング** | ページ設計、副作用の配置、認証/認可チェック、レイアウト構成 |
| `src/lib` | **ライブラリ** | 純粋関数、型安全性、エラーハンドリング、入力バリデーション |
| `src/app/api` | **APIルート** | 入力バリデーション、認証、SQLインジェクション、レスポンス形式 |
| その他 | **汎用** | 命名規則、構造、セキュリティ、パフォーマンス |

### 除外ルール

以下のディレクトリは**自動的に除外**する（ユーザーが明示的に指定した場合を除く）。

- `src/components/ui/` — Shadcn UI 等の外部ライブラリ由来
- `node_modules/`, `.next/`, `.git/` — ビルド・設定系
- `__tests__/`, `*.test.*`, `*.spec.*` — テストファイル（レビュー対象外だが、テストの存在有無は確認する）

## フェーズ1: 対象ディレクトリの列挙

1. ユーザーが指定したディレクトリの**直下サブディレクトリ**を一覧取得する
2. 除外ルールに該当するディレクトリを除外する
3. 取得したサブディレクトリのリストを表示し、処理順序を確認する

**出力例:**
```
対象種別: コンポーネント（src/components）
レビュー対象ディレクトリ（計 N 件）:
1. auth/
2. home-legacy/
3. profile-list/
...
```

## フェーズ2: サブディレクトリごとのイテレーション

**各サブディレクトリに対して、以下のステップ1〜5を順番に実行する。**
1つのサブディレクトリの処理が完了してから、次のサブディレクトリに進むこと。

### ステップ1: 潜在的バグと仕様逸脱の検出

- ロジックの誤り、オフバイワンエラー、null/undefined参照の可能性
- 非同期処理（async/await）の漏れや競合状態
- 例外処理の不足や握りつぶし
- 状態管理の不整合（useEffectの依存配列、再レンダリング問題）
- 型安全性の欠如（`any` 型の不適切な使用、型アサーションの乱用）

### ステップ2: パフォーマンス劣化の検出

- 不要な再レンダリングを引き起こすパターン
- N+1クエリや非効率なデータ取得
- メモ化すべき重い計算やコンポーネント
- バンドルサイズへの影響（不要なインポート、大きな依存関係）

### ステップ3: セキュリティ・可用性のレビュー

- **XSS**: `dangerouslySetInnerHTML` の使用、ユーザー入力の未サニタイズ
- **SQLインジェクション**: 文字列結合によるクエリ構築
- **認証/認可**: RLS（Row Level Security）の適用漏れ、認証チェックの不足
- **入力バリデーション**: Zodスキーマの未適用、サーバーサイドでの検証漏れ
- **Server Actions**: `use server` の不適切な使用（REST API推奨）
- **CSRF/CORS**: 適切なヘッダー設定
- **機密情報**: APIキーやシークレットのハードコード

### ステップ4: テストカバレッジの確認

- 対象ディレクトリ内のファイルに対応するテストファイルが存在するか？
- 存在しない場合、欠落テストの種類や想定ケースを指摘する
- 既存テストがある場合、カバレッジの十分性を簡潔に評価する

### ステップ5: コード品質と規約準拠

- `user_rules` および `.agent/rules` のルールに準拠しているか？
- 命名規則（ケバブケース、名前付きエクスポート等）に従っているか？
- コロケーション・バレルファイルのルールに従っているか？
- JSDocコメントは適切か？
- `readonly` / `as const` のイミュータビリティルールに従っているか？

### サブディレクトリ完了時の記録

各サブディレクトリの処理完了時に、以下の形式で記録する。
指摘は優先度順（致命的 > 重大 > 注意 > 軽微）にソートすること。

```
## [ディレクトリ名] - レビュー完了

### 指摘事項
| # | 優先度 | カテゴリ | ファイル:行 | 内容 | 修正の方向性 |
|---|--------|----------|-------------|------|-------------|
| 1 | 致命的 | セキュリティ | foo.ts:42 | 説明 | 修正案 |
| 2 | 重大   | バグ       | bar.tsx:15 | 説明 | 修正案 |

### テスト状況
- テストあり: N ファイル
- テスト欠落: N ファイル（一覧）

### 所見
- 問題なし / 要対応事項の要約
```

## フェーズ3: サマリーレポート

全サブディレクトリの処理完了後、以下のサマリーを出力する：

```
# レビュー全体レポート

## 統計
- 対象種別: [コンポーネント / ルーティング / ライブラリ / API / 汎用]
- レビューディレクトリ数: N
- 指摘総数: N 件（致命的: N / 重大: N / 注意: N / 軽微: N）
- テスト欠落: N ファイル

## ディレクトリ別結果
| ディレクトリ | 致命的 | 重大 | 注意 | 軽微 | テスト |
|---|---|---|---|---|---|
| auth/ | 0 | 1 | 2 | 0 | ✅ |
| ...   | . | . | . | . | .. |

## 要対応事項（優先度順）

### 致命的
1. [ファイル:行] — 内容と修正の方向性

### 重大
1. [ファイル:行] — 内容と修正の方向性

### 注意
1. ...

## 残るリスクと追加検証が望ましい箇所
- ...
```

# 重要な制約

1. **1ディレクトリずつ処理すること** — まとめて処理しない
2. **各ディレクトリのファイルを全て読むこと** — ファイル一覧だけで判断しない
3. **コード修正は行わない** — レビュー（指摘と報告）のみ行う
4. **優先度を明確にすること** — 致命的 > 重大 > 注意 > 軽微
5. **ファイルと行番号を必ず明示すること** — 曖昧な指摘は禁止
6. **問題が見つからなくても報告する** — 残るリスクや追加検証事項を記録
7. **除外ルールに従う** — `ui/`, `node_modules/` 等は除外
8. **修正の方向性を示すこと** — 問題の指摘だけでなく、どう直すべきかを提案する
