---
trigger: always_on
---

# エラーハンドリング基準 (Error Handling Standards)

VNS masakinihirota アプリケーションにおける、堅牢でユーザーフレンドリーなエラーハンドリング基準を定義します。

## 1. クライアントサイド (React/Next.js)

### Error Boundary の設置
- **ルートレベル**: `global-error.tsx` を定義し、アプリケーション全体のクラッシュを防ぐ。
- **レイアウトレベル**: `error.tsx` を各ルートセグメントに配置し、エラーの影響範囲を局所化する。
- **コンポーネントレベル**: 重要なUIパーツ（決済フォーム、複雑なグラフ等）には個別に `ErrorBoundary` をラップし、部分的なエラーでも他の機能が使えるようにする。

### try-catch の適切な使用
- **データ取得・操作**: Server Components や Event Handler 内での非同期処理には必ず `try-catch` ブロックを使用する。
- **エラーの握りつぶし禁止**: `catch (e) {}` のようにエラーを黙殺しない。必ずユーザーへのフィードバックか、ログ送信を行う。

### エラーログの送信
- **Sentry等の活用**: クライアントサイドで発生した予期せぬエラーは、コンソールに出力するだけでなく、エラー監視サービス（Sentry等）に送信する。

## 2. サーバーサイド (Next.js API Routes / Server Actions)

### エラーレスポンスの統一形式
- API エラーは以下の JSON 形式で返すことを基本とする：
  ```json
  {
    "error": {
      "code": "INVALID_INPUT",
      "message": "入力されたメールアドレスの形式が正しくありません。",
      "details": { ... }
    }
  }
  ```

### ステータスコードの適切な使用
- **400 Bad Request**: クライアントの入力ミス（バリデーションエラー）。
- **401 Unauthorized**: 認証が必要、または認証切れ。
- **403 Forbidden**: アクセス権限がない。
- **404 Not Found**: リソースが存在しない。
- **500 Internal Server Error**: サーバー側の予期せぬエラー。

### エラーログの記録
- サーバーサイドエラーは、スタックトレースと共に構造化ログとして出力する（JSON形式推奨）。

## 3. ユーザーフィードバック

### 具体的なメッセージ
- 「エラーが発生しました」だけの抽象的なメッセージは避ける。可能な限り「何が起きたか」と「どうすればよいか」を伝える（`ux-feedback-messages.md` 参照）。

### トーストとアラートの使い分け
- **一時的なエラー**: トースト通知（自動で消える）。
- **継続的なエラー/重要なお知らせ**: アラートバナー（ユーザーが閉じるまで消えない）。
