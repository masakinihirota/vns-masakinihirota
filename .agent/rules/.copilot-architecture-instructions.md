---
trigger: always_on
---

# アーキテクチャ・TDD・ディレクトリ構成指示書

> **📖 関連ドキュメント**
>
> - コアルール: [.copilot-codeGeneration-instructions.md](./.copilot-codeGeneration-instructions.md)
> - 技術スタック: [.copilot-techstack.md](./.copilot-techstack.md)

## 1. TDD実行手順（AIへの依頼）

AIは、選択した**細分化タスク**を完了させるため、以下のRGRサイクルを順に実行すること。

### 1.1. テストファイル命名規則

| ファイル種別       | 命名規則                                         | 用途                                 |
| ------------------ | ------------------------------------------------ | ------------------------------------ |
| **View関連**       | `*.test.tsx`                                     | UIコンポーネントのテスト             |
| **ロジック/Fetch** | `*.logic.test.ts`, `*.logic.integration.test.ts` | ビジネスロジック、データ取得のテスト |

- テストファイルは、テストするコンポーネントやロジックと同じディレクトリに配置し、関連性を明確にします。

### 1.2. テスト記述規約

| 項目                     | ルール                                                                     |
| ------------------------ | -------------------------------------------------------------------------- |
| **テストフレームワーク** | Vitest + React Testing Library                                             |
| **テスト構造**           | `describe` でコンポーネント/関数名、`it` で具体的な振る舞い                |
| **言語**                 | テストケース名は日本語で記述し、仕様を明確にする                           |
| **パターン**             | AAA パターン（Arrange（準備）、Act（実行）、Assert（検証））を明確に分ける |

**例:**

```typescript
describe("ProfileList", () => {
  it("名前を表示する", () => {
    // Arrange
    const props = { name: "山田太郎", role: "エンジニア", bio: "開発者" };

    // Act
    render(<ProfileList {...props} />);

    // Assert
    expect(screen.getByText("山田太郎")).toBeInTheDocument();
  });
});
```

### 1.3. RGRサイクル

#### 🔴 ステップ1: テストコードの生成（REDフェーズ）

1. タスクの要件を満たすための**失敗するテストコード**を、該当する**テストファイル**（例: `[ComponentName].test.tsx`）に記述する。
2. テストを実行し、**失敗（RED）すること**を確認する。

#### 🟢 ステップ2: アプリケーションコードの生成（GREENフェーズ）

1. ステップ1で生成したテストを**すべて合格させる**ための**最小限のアプリケーションコード**を、対応するファイルに記述する。
2. テストを再度実行し、**すべてがグリーン（合格）**になることを確認する。

#### ✨ ステップ3: リファクタリング（REFACTORフェーズ）

1. テストがグリーンであることを前提に、生成したコードに対して**品質、可読性、効率**を高めるためのリファクタリングを提案・実行する。
2. リファクタリング後、**テストが引き続きグリーン**であることを最終確認し、**タスクを完了（チェック）**とする。

---

## 2. コード生成の基本方針

| 原則               | 詳細                                                                                                           |
| ------------------ | -------------------------------------------------------------------------------------------------------------- |
| **レビューと理解** | コードを記述する前に、既存のコードを深くレビューし、その動作を正確に理解する                                   |
| **簡潔性と正確性** | 正確な例を用い、簡潔で技術的に正しいTypeScriptコードを記述する                                                 |
| **宣言的なJSX**    | 読みやすく、意図が明確な宣言的なJSXを記述する                                                                  |
| **関数型・宣言型** | 関数型および宣言型のプログラミングパターンを優先し、クラスベースの実装は避ける                                 |
| **ROROパターン**   | 必要に応じて、オブジェクトを受け取り、オブジェクトを返すROROパターンを使用する                                 |
| **ファイル構成**   | エクスポートされるコンポーネント、サブコンポーネント、ヘルパー関数、静的コンテンツ、型定義などでファイルを構成 |
| **ファイルサイズ** | 1ファイルの行数は500行以内を目安とし、これを超える場合は適切にファイルを分割する                               |
| **エクスポート**   | コンポーネントは名前付きエクスポート (`export const MyComponent = ...`) を使用する                             |

---

## 3. ファイル・ディレクトリ構成

重要: このプロジェクトでは「ルーティング（ページ）」と「コンポーネント（UI/ビジネスロジック）」を明確に分離し、さらにコンポーネントごとに責務を分けることで可読性とテスト容易性を高めます。

### 3.1. ルーティングとコンポーネントの分離

| レイヤー           | 配置場所                                 | 責務                                                                 |
| ------------------ | ---------------------------------------- | -------------------------------------------------------------------- |
| **ページ**         | `src/app/<route>/page.tsx`, `layout.tsx` | 「どのコンポーネントを並べるか」のみ。副作用（データ取得）は持たない |
| **コンポーネント** | `src/components/<page-name>/`            | UI、ロジック、データ取得を含む機能実装                               |

- ページは表示とコンポーネントの組み立てに専念
- データの取得（フェッチ）は各機能・コンポーネント配下の `*.logic.ts` や `*.fetch.ts` に配置

### 3.2. コンポーネントのコロケーション（責務別ファイル配置）

各コンポーネントは独立したフォルダにし、UI・ロジック・fetch・テストを分割します。

**例:**

```
src/components/profile-list/profile-list/
├─ profile-list.tsx                    # プレゼンテーション（UI）
├─ profile-list.container.tsx          # コンテナコンポーネント（状態管理）
├─ profile-list.logic.ts               # ビジネスロジック／ユーティリティ
├─ profile-list.logic.test.ts          # ロジックのユニットテスト
├─ profile-list.logic.integration.test.ts  # ロジックの結合テスト
└─ profile-list.test.tsx               # UIコンポーネントのテスト
```

**コロケーションの利点:**

- 関連ファイルがまとまっているため、変更範囲が分かりやすい
- Agent による自動生成やテスト作成が容易

### 3.3. Barrel Export と ネームスペースインポート

ページ単位で使うコンポーネント群は `src/components/<page-name>/index.ts` で名前付きエクスポートし、ページ側でネームスペースインポートします。

**Barrel Export（`src/components/profile-list/index.ts`）:**

```typescript
// 📌 Barrel Export: 再エクスポート専用、ロジック記述禁止
export { ProfileList } from "./profile-list/profile-list";
export { ProfileListContainer } from "./profile-list/profile-list.container";
export type { Profile, SortOrder } from "./profile-list/profile-list.logic";
```

**ページ側のインポート（`src/app/sample/page.tsx`）:**

```typescript
// ネームスペースインポートで可読性を確保
import * as Sample from "../../components/profile-list";

export default function SamplePage() {
  return (
    <>
      <Sample.ProfileListContainer />
    </>
  );
}
```

### 3.4. データフェッチの配置原則

| 項目               | ルール                                                             | 理由                         |
| ------------------ | ------------------------------------------------------------------ | ---------------------------- |
| **配置場所**       | `src/components/**/*.logic.ts` または `*.fetch.ts`                 | 機能単位で副作用を完結させる |
| **ページ側**       | 原則フェッチ禁止（表示・組み立て専念）                             | テストとモックが容易         |
| **例外**           | ページレベル集約が必要な場合のみ `page.tsx` に配置可（推奨しない） | 現実的制約への対応           |
| **データ受け渡し** | props 経由を優先                                                   | 依存関係の明示化             |
| **Server Actions** | 許容（責務はページ側で集約）                                       | Next.js のベストプラクティス |

### 3.5. 命名とエクスポート方針

| 項目                   | ルール                                                 |
| ---------------------- | ------------------------------------------------------ |
| **エクスポート**       | デフォルトエクスポート禁止、名前付きエクスポートを使用 |
| **フォルダとファイル** | フォルダ名とファイル名は一致させ、パス解決を簡潔に     |
| **ディレクトリ名**     | ケバブケース (例: `components/profile-list`)           |

### 3.6. テストの分離

| テスト種別         | ファイル名                    | 対象                                   |
| ------------------ | ----------------------------- | -------------------------------------- |
| **UIテスト**       | `*.test.tsx`                  | コンポーネントの表示・インタラクション |
| **ロジックテスト** | `*.logic.test.ts`             | ビジネスロジックのユニットテスト       |
| **結合テスト**     | `*.logic.integration.test.ts` | データ取得を含む結合テスト             |

### 3.7. 完全な構成例

**ディレクトリ構造:**

```
src/
├── app/
│   └── sample/                    # サンプルページ
│       ├── page.tsx               # ページコンポーネント（副作用は持たず表示に専念）
│       └── page.test.tsx          # ページコンポーネントのテスト
└── components/
    ├── profile-list/              # ページ単位コンポーネント群
    │   ├── index.ts               # Barrel Export（再エクスポート専用）
    │   └── profile-list/          # ProfileList機能単位コンポーネント群
    │       ├── profile-list.tsx                    # プレゼンテーション（UI）
    │       ├── profile-list.container.tsx          # コンテナ（状態管理）
    │       ├── profile-list.logic.ts               # ビジネスロジック
    │       ├── profile-list.logic.test.ts          # ロジックのユニットテスト
    │       ├── profile-list.logic.integration.test.ts  # ロジックの結合テスト
    │       └── profile-list.test.tsx               # UIコンポーネントのテスト
    └── ui/                        # 共通UIコンポーネント（Shadcn/UI）
        ├── avatar.tsx
        └── card.tsx
```

---

## 4. Supabase / Drizzle の命名規約

| 項目               | ルール                                                                                        | 参照                                                                                                            |
| ------------------ | --------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| **PostgreSQL準拠** | 未引用識別子は63文字以内、アルファベットまたはアンダースコアで開始、英数字/アンダースコアのみ | [PostgreSQL 識別子仕様](https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) |
| **ケース統一**     | `snake_case` で統一（Drizzle の `casing: 'snake_case'` 設定使用）                             | [Drizzle ドキュメント](https://orm.drizzle.team/docs/sql-schema-declaration#camel-and-snake-casing)             |
| **命名ガード**     | 全識別子は63文字以内、明確な意味、略語は最低限                                                | -                                                                                                               |
| **真実の源泉**     | `src/db/schema/*.ts` を真実の源泉とし、Supabaseマイグレーションと同一ソース扱い               | -                                                                                                               |
| **自動検証**       | マイグレーション生成前に命名規則を自動検証                                                    | -                                                                                                               |

---

## 5. サンプルコード参照

本プロジェクトの実装例として `src/app/sample` と `src/components/profile-list` が存在します。

**主要パターン:**

- **ページ:** `src/app/<route>/page.tsx` - 副作用なし、表示のみ
- **コンポーネント:** `src/components/<page-name>/` - 機能単位で分離
- **Barrel Export:** `index.ts` で名前付きエクスポートを集約
- **テスト:** UI（`*.test.tsx`）とロジック（`*.logic.test.ts`）を分離

実装の詳細は上記のサンプルディレクトリを参照してください。

---
