---
trigger: always_on
description: IPA「安全なウェブサイトの作り方」に基づくSQLインジェクション、XSS、CSRF等のセキュリティ対策実装指針
---

# IPA「安全なウェブサイトの作り方」実装指針

本プロジェクトでは、IPAのガイドラインを遵守し、以下の通り対策を実装する。

## 1. SQLインジェクション

- **対策**: Supabase (PostgreSQL) クライアントライブラリのメソッドチェーン（`.select()`, `.insert()` 等）を使用する。
- **禁止**: 文字列結合によるSQL構築は厳禁とする。
- **注意**: `rpc()` を使用してServer Side Functionを呼び出す際や、`pg` ライブラリを直接使用する場合は、必ずパラメータ化されたクエリを使用する。

## 2. OSコマンド・インジェクション

- **対策**: サーバーサイドでのOSコマンド実行（`child_process` 等）は原則禁止する。
- **例外**: 開発ツールやビルドスクリプトを除く、アプリケーションロジック内での使用は、セキュリティレビューを経た場合のみ許可する。

## 3. パス名パラメータの未チェック／ディレクトリ・トラバーサル

- **対策**: ファイルシステムへのアクセスが発生する場合、ユーザー入力をそのままパスとして使用しない。
- **実装**: `path.basename()` でファイル名のみを抽出するか、許可されたファイル名のリスト（ホワイトリスト）と照合する。

## 4. セッション管理の不備

- **対策**: 認証には必ず **Supabase Auth** を使用する。
- **実装**: セッションIDの生成・管理はSupabase SDKに任せ、独自実装しない。クッキーは `Secure`, `HttpOnly`, `SameSite=Lax/Strict` 属性を付与する（Supabase SSRヘルパーのデフォルト設定に従う）。

## 5. クロスサイト・スクリプティング (XSS)

- **対策**: Reactの標準エスケープ機能に頼る。
- **禁止**: `dangerouslySetInnerHTML` の使用は原則禁止する。どうしても必要な場合は、DOMPurify 等でサニタイズしたHTMLのみを渡す。
- **注意**: `href` 属性に `javascript:` スキームが含まれないよう、リンク先URLを検証する。

## 6. CSRF（クロスサイト・リクエスト・フォージェリ）

- **対策**: 状態を変更するリクエスト（POST/PUT/DELETE）は、Server Actions または Route Handlers で処理する。
- **実装**: Supabase Auth のクッキー設定（SameSite属性）を確認し、ブラウザの標準的な保護機構を有効にする。

## 7. HTTPヘッダ・インジェクション

- **対策**: ユーザー入力をHTTPレスポンスヘッダの値として出力しない。
- **実装**: `NextResponse` でヘッダを設定する場合、入力値の改行コードを削除・検証する。

## 8. メールヘッダ・インジェクション

- **対策**: アプリケーションからメールを送信する場合、ヘッダフィールド（To, Cc, Bcc, Subject）に改行コードを含めないようサニタイズする。可能な限りSupabase Authのメール機能や、SendGrid等のAPIを利用する。

## 9. クリックジャッキング

- **対策**: ページを `<iframe>` 内に表示させることを禁止する。
- **実装**: HTTPレスポンスヘッダに `X-Frame-Options: DENY` または `SAMEORIGIN` を設定する。`Content-Security-Policy: frame-ancestors 'none'` も併用する。

## 10. バッファオーバーフロー

- **対策**: 大量データの入力や無限ループを防ぐ。
- **実装**: APIルートでのリクエストボディサイズ制限（Next.jsデフォルトは4MB等）を適切に設定する。ループ回数や再帰の深さに上限を設ける。

## 11. アクセス制御や認可制御の欠落

- **対策**: データアクセスは必ず **RLS (Row Level Security)** で制御する。
- **実装**:
  - クライアントサイドでの表示制御（条件付きレンダリング）はUXのためであり、セキュリティ対策ではないと認識する。
  - APIルートやServer Actions内でも、必ず `supabase.auth.getUser()` 等でユーザーを特定し、権限を確認する。

---

**参考資料**:

- [IPA「安全なウェブサイトの作り方」](https://www.ipa.go.jp/security/vuln/websecurity.html)
