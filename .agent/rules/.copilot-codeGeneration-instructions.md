---
trigger: always_on
---

# コード生成指示書（コアルール）

> **📖 関連ドキュメント**
>
> - アーキテクチャ・TDD: [.copilot-architecture.md](./.copilot-architecture.md)
> - 技術スタック: [.copilot-techstack.md](./.copilot-techstack.md)
> - Supabase宣言型スキーマ: [declarative-supabase-schemas.md](./declarative-supabase-schemas.md)

## 1. このファイルの役割

このファイルは、**コード生成時の必須ルール**を定義します。不変性、予測可能性、テスト容易性を確保し、ランタイムエラーを最小限に抑えるための厳格な規範です。

**他のファイルとの関係:**

- 本ファイル: コアルール（2.1〜2.5）- コード生成時、常に参照
- architecture.md: アーキテクチャとTDD手順（2.6〜2.9）- 新規機能実装時
- techstack.md: 技術スタック詳細（1.2, 3〜5）- 技術選定時

---

## 2. AIコーディング規範（必須ルール）

### 目的

AIは、本規範に厳格に従い、**不変性、予測可能性、そして完全なテスト容易性**を確保したコードを生成すること。例外処理は型システムで強制し、ランタイムエラーの発生を最小限に抑える。

### 2.1. 構造とモジュール化のルール (Modularity & Architecture)

| No.     | 必須ルール              | 詳細（AIへの指示）                                                                                                                                        |
| :------ | :---------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **I-1** | **テストの最重要性**    | **結合テスト**が最も重要であり、全ての機能は厳格なテストの下で実装されること。                                                                            |
| **I-2** | **インポート管理**      | `require` および 一般的な `import` 文は禁止。必ず **`import` 宣言**を使用し、eslint-plugin-boundariesに従い、ディレクトリのインポート方向を強制すること。 |
| **I-3** | **サブパス禁止**        | `import "hoge/sub"` のような深い階層のサブパス import は禁止。常に公開されたパスからインポートすること。                                                  |
| **I-4** | **Barrel Export 厳守**  | 各ディレクトリには必ず **`index.ts`** ファイルを設置し、そのレイヤーで公開してよいものだけを export すること。                                            |
| **I-5** | **Index.ts の純粋性**   | `index.ts` は **re-export 以外**のロジック（関数定義など）を記述してはならない。                                                                          |
| **I-6** | **Default Export 禁止** | `export default` は使用せず、全て **名前付きエクスポート (Named Export)** を使用すること。                                                                |

### 2.2. 機能とデータ処理のルール (Functional & Data Flow)

| No.       | 必須ルール                         | 詳細（AIへの指示）                                                                                                                                                                                                                                                                      |
| :-------- | :--------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **II-1**  | **クラス禁止**                     | `class` の定義は原則禁止。互換性維持など、どうしても必要な場合のみ例外的に許可する。                                                                                                                                                                                                    |
| **II-2**  | **Enum 禁止**                      | `enum` は絶対に使用しないこと。                                                                                                                                                                                                                                                         |
| **II-3**  | **完全な不変性**                   | 変数の再代入を防ぐため、**`let` の使用を禁止**し、全ての変数を `const` で宣言すること。オブジェクトや配列の型には必ず **`readonly`** を付与し、不変性を強制すること。                                                                                                                   |
| **II-4**  | **Argument Object 強制**           | 関数の引数が 2 つ以上になる場合、必ず **単一のオブジェクト（名前付き引数パターン）**として渡すこと。                                                                                                                                                                                    |
| **II-5**  | **シャドーイング禁止**             | スコープ外の変数と同じ名前の変数を、内側のスコープで宣言すること（シャドーイング）を禁止する。                                                                                                                                                                                          |
| **II-6**  | **マジックバリュー禁止**           | コード内に直接、意味の不明瞭な数値や文字列（マジックナンバー、マジックストリング）を記述することを禁止。必ず `const` 定義すること。                                                                                                                                                     |
| **II-7**  | **配列操作の不変性保証**           | 配列を操作する際は、必ず元の配列をコピーしてから操作すること。`[...array]` や `Array.from()` でコピー。`.map()`, `.filter()`, `.reduce()` など新しい配列を返すメソッドを推奨。`.sort()`, `.reverse()`, `.push()`, `.pop()` などの破壊的メソッドを元の配列に直接適用することを禁止する。 |
| **II-8**  | **Optional Chaining の積極的使用** | 配列やオブジェクトのプロパティアクセス時は、可能な限り Optional Chaining (`?.`) を使用すること。`null` / `undefined` チェックを明示的に行う代わりに、`?.` で安全にアクセスする。                                                                                                        |
| **II-9**  | **型定義の明確化**                 | 限定された値の集合を表現する場合、`enum` ではなく Union Types を使用すること。複雑な型や再利用される型は `type` で定義。リテラル型を保証する場合は `as const` を使用すること。例: `type SortOrder = "asc" \| "desc";`                                                                   |
| **II-10** | **国際化対応**                     | `localeCompare` などのロケール依存処理で、ロケール文字列（`"ja"`, `"en"` など）を直接記述することを禁止。ロケールは環境変数または定数ファイルで一元管理すること。例: `const LOCALE = "ja" as const;`                                                                                    |

### 2.3. エラーと非同期処理のルール (Error Handling & Types)

| No.       | 必須ルール             | 詳細（AIへの指示）                                                                                                             |
| :-------- | :--------------------- | :----------------------------------------------------------------------------------------------------------------------------- |
| **III-1** | **Throw 禁止**         | 例外を発生させる `throw` 文は禁止。                                                                                            |
| **III-2** | **Try/Catch 禁止**     | `try / catch` の使用は、外部システムとの境界（腐敗防止層）でのみ許可し、それ以外のレイヤーでは禁止する。                       |
| **III-3** | **非同期処理の型**     | `Promise` を直接返さず、必ず **`ResultAsync`** のような Result 型に寄せて、成功/失敗の結果を型で明示すること。                 |
| **III-4** | **Zod safeParse 強制** | Zod ライブラリを使用する際、検証メソッドは `parse` ではなく、必ず **`safeParse`** を使用すること。                             |
| **III-5** | **型アサーション禁止** | `as` や `!` (非 null アサーション) を使用した型アサーションを禁止する。必ず型ガード関数や適切なチェックで型を絞り込むこと。    |
| **III-6** | **ネストの制限**       | 制御フロー（`if`, `for`, `while` など）のネストは深さ **1** までとし、早期リターン（ガード節）を用いてコードを平坦に保つこと。 |

### 2.4. AI運用とテスト・品質ガード（Operational & AI-specific rules）

| No.      | 必須ルール                                             | 詳細（AIへの指示）                                                                                                                                                                                                                                     |
| :------- | :----------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **IV-1** | **暗黙のフォールバック禁止 (No implicit fallback)**    | LLM による勝手な補完・暗黙のフォールバックを禁止します。欠損値や想定外の状態については、必ず明示的に失敗を返す（Result 型等）か、仕様として事前に定義されたフォールバックを適用してテストで検証してください。                                          |
| **IV-2** | **ダミー/NO-OP 実装の禁止 (No mocking in production)** | プロダクション用コード内での NO-OP / ダミー実装を禁止します。テストでモックを使う場合でも、必ず"実 DB を用いた結合テスト"を作成し、モックのみで成功するケースを許容しないこと。                                                                        |
| **IV-3** | **fail-fast の条件付き適用**                           | `fail-fast` を無条件に適用することを禁止します。fail-fast を採用する場合はリスク評価と回復戦略（リトライ、代替処理、監視/アラート）を明文化し、該当箇所を限定（例: 腐敗防止層）してテストで検証すること。                                              |
| **IV-4** | **結合テスト重視・サーバー側実DB使用・カバレッジ目標** | サーバー側 API/Repository は「実 DB を用いた結合テスト」を必須とし、サーバー側コードのカバレッジは **100% を目標** とする（現実的制約がある場合は CI によるフル結合テストの夜間実行等の補完を許可）。                                                  |
| **IV-5** | **TSDoc の厳格化**                                     | 公開 API、Repository メソッド、Server Actions、複雑な関数には必ず TSDoc を記述し、`目的 (purpose)`, `内容 (params/returns)`, `注意事項 (remarks)` を必須化する。日本語で記載し、@example を用いて使い方を示すこと。                                    |
| **IV-6** | **CI と linter による自動阻止**                        | 上記ルールは文書化するだけでなく、CI と linter（ESLint + 各種プラグイン）で自動検出・阻止できる仕組みを必ず導入すること。PR マージ前にルール違反がある場合はブロックされるように設定する（TSDoc 必須チェック、禁止構文の検出、カバレッジゲートなど）。 |

**運用メモ**:

- ルールは必ず CI と lint で守らせる。単にルールを書くだけでは不十分。
- テスト用モックは許されるが、その場合でも「モックでのみグリーンになるテスト」を許さず、実 DB を利用した結合テストを同等レベルで確保すること。

### 2.5. 命名規則

- **PascalCase:** コンポーネント名、インターフェース、型エイリアス。
- **camelCase:** 変数、関数、メソッド。
- **アンダースコアプレフィックス (`_`):** プライベートなクラスメンバー（クラスの使用は原則避けるため、適用場面は限定的です）。
- **ALL_CAPS:** 定数。
- **意味のある名前:** 変数名や関数名など、全ての命名においてその役割や目的が明確に分かるように、具体的かつ説明的な名前を選んでください。
- **補助動詞:** `isLoading`, `hasError` のように、状態を表す変数は補助動詞を用いて説明的にします。

---

## 3. まとめ

本ファイルで定義されたコアルールは、コード生成時に**常に**参照されるべき必須事項です。

**アーキテクチャやTDD手順** → [.copilot-architecture.md](./.copilot-architecture.md)
**技術スタックの詳細** → [.copilot-techstack.md](./.copilot-techstack.md)

これらのルールに従うことで、保守性が高く、テスト可能で、予測可能なコードベースを維持できます。

---
