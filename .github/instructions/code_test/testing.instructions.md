---
applyTo: "*.js,*.jsx,*.ts,*.tsx,*.css,*.scss,*.sass,*.json,*.env"
---

# テスト駆動開発（TDD）指示書 - t-wada方式

## **このファイルの役割**

このファイルは、GitHub CopilotがTDD（Test-Driven Development）を実践する際の具体的な指示を定義します。t-wada氏による正統的なテスト駆動開発の定義に基づき、React/Next.jsプロジェクトでの実践的なTDDワークフローを提供します。

---

## **テスト駆動開発の基本原則**

### **テスト駆動開発とは何か**

テスト駆動開発は以下のステップを短いサイクルで繰り返す開発手法です：

1. **設計** - 振る舞いの分析とテストリストの作成
2. **レッド** - 失敗するテストを1つだけ書く
3. **グリーン** - テストを成功させる最小限のコードを書く
4. **リファクタリング** - 設計を改善する（必要に応じて）

### **TDDの狙い**

- それまで動作していたものは引き続き全て動作する
- 新しい振る舞いは期待通りに動作する
- システムはさらなる変更の準備ができている
- プログラマとその同僚は、上記の点に自信を持っている

---

## **TDDサイクル：具体的な開発ステップ**

### **ステップ1：テストリストの作成（設計）**

**最重要：** 実装前に必ずテストリストを作成します。これがTDDの出発点です。

**やるべきこと：**
- 振る舞いの分析を行い、期待される動作をリストアップ
- テスト容易性と重要度を考慮してテストリストを作成
- 簡単かつ重要度の高いものを上位に配置
- テストの粒度は「1-2時間で完了する」レベルに調整

**やってはいけないこと：**
- 実装の設計判断を混ぜ込む
- いきなりコードを書き始める
- テストリストを最後まで書いてしまう

```typescript
// テストリストの例（Reactコンポーネントの場合）
/*
TODO: UserProfileコンポーネント
====================================
テスト容易性：高 重要度：高
- [ ] ユーザー名が正しく表示される
- [ ] デフォルトアバター画像が表示される
- [ ] プロフィール編集ボタンがクリック可能

テスト容易性：中 重要度：高
- [ ] 編集ボタンクリック時にモーダルが開く
- [ ] 空のユーザー名の場合にエラーメッセージが表示される

テスト容易性：低 重要度：中
- [ ] アバター画像のアップロード機能
- [ ] プロフィール保存時のバリデーション
*/
```

### **ステップ2：ひとつテストを書く（レッド）**

テストリストから**1つだけ**選んで、失敗するテストを書きます。

**やるべきこと：**
- 準備・実行・検証（アサーション）が備わった自動化されたテストを書く
- テストを選ぶ順番を慎重に考える
- アサーションから書き始めて逆向きに書き進める
- テストは1つの動作のみを検証する

**やってはいけないこと：**
- アサーションのないテストコードを書く
- 複数のテストを同時に書く
- 先にテストリストをすべてテストコード化する

```typescript
// テストの例（React Testing Library + Vitest）
import { render, screen } from '@testing-library/react';
import { describe, it, expect } from 'vitest';
import '@testing-library/jest-dom';
import UserProfile from './UserProfile';

describe('UserProfile', () => {
  it('ユーザー名が正しく表示される', () => {
    const user = { name: 'テストユーザー', avatar: null };
    render(<UserProfile user={user} />);
    expect(screen.getByText('テストユーザー')).toBeInTheDocument();
  });
});
```

### **ステップ3：テストを成功させる（グリーン）**

失敗するテストを成功させる**最小限**のコードを書きます。

**やるべきこと：**
- テストを成功させる最小限の実装のみ
- 新しいテストの必要性に気づいたらテストリストに追加
- テストが成功したら「済」マークをつける
- 必要十分かつシンプルな実装を心がける

**やってはいけないこと：**
- アサーションを削除してテストを成功させる
- テスト対象を動かした値をコピーして期待値にペーストする
- テストを書きながらリファクタリングも一緒にやる
- 早すぎる抽象化や共通化

```typescript
// 最小限の実装例
interface User {
  name: string;
  avatar: string | null;
}

interface UserProfileProps {
  user: User;
}

const UserProfile: React.FC<UserProfileProps> = ({ user }) => {
  return <div>{user.name}</div>;
};

export default UserProfile;
```

### **ステップ4：リファクタリング**

必要に応じてコードの設計を改善します。

**やるべきこと：**
- コードをよりシンプルで理解しやすいものにする
- 重複の排除
- 責任の分離
- 変数名や関数名の改善

**やってはいけないこと：**
- テストを変更する（外部仕様を変えない）
- 必要以上のリファクタリング
- 早すぎる抽象化や共通化

### **ステップ5：繰り返し**

テストリストが空になるまで、ステップ2-4を繰り返します。

---

## **自動テストの条件**

### **必須条件**

#### **自己検証可能**
- テストは成功か失敗かの2つの結果のみ
- 人間の目を介さずに自分で判断できる

#### **繰り返し可能（Repeatable）**
- 誰が、いつ、どこで実行しても同じ結果
- 手動でのデータリセットやファイル削除が不要

### **強く推奨される性質**

#### **独立している（Independent/Isolated）**
- テストが他のテストに影響を与えない
- 実行順序に関係なく同じ結果
- **単一責任**: 各テストは1つの特定の動作のみを検証

#### **高速**
- テストの実行が速い
- 頻繁な実行が可能

---

## **技術スタック**

### **使用技術**
- **テストフレームワーク**: Vitest
- **UIテストライブラリ**: React Testing Library
- **アサーションライブラリ**: @testing-library/jest-dom
- **ファイル構成**: コロケーション（テストファイルはコンポーネントと同じ場所）
- **ファイル拡張子**:
  - テストファイル: `*.test.tsx`
  - コンポーネントファイル: `*.tsx`

---

## **Vitestを使用したテスト実装ガイドライン**

### **基本的なテストの書き方**

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect } from 'vitest';
import '@testing-library/jest-dom';
import ComponentName from './ComponentName';

describe('ComponentName', () => {
  it('should render the component with initial text', () => {
    render(<ComponentName />);
    expect(screen.getByText('Hello')).toBeInTheDocument();
  });

  it('should change text on button click', () => {
    render(<ComponentName />);
    fireEvent.click(screen.getByRole('button'));
    expect(screen.getByText('Clicked!')).toBeInTheDocument();
  });
});
```

### **非同期処理のテスト**

```typescript
it('should load data asynchronously', async () => {
  render(<AsyncComponent />);

  // 非同期処理の完了を待つ
  const loadedData = await screen.findByText('Loaded Data');
  expect(loadedData).toBeInTheDocument();
});
```

### **モックの使用**

```typescript
import { vi } from 'vitest';

it('should call the onClick handler', () => {
  const mockOnClick = vi.fn();
  render(<Button onClick={mockOnClick}>Click me</Button>);

  fireEvent.click(screen.getByRole('button'));
  expect(mockOnClick).toHaveBeenCalledTimes(1);
});
```

---

## **React/Next.jsでのTDD実践指針**

### **コンポーネントのテスト対象**

1. **レンダリングテスト** - コンポーネントが正しく表示されるか
2. **イベントハンドリングテスト** - ユーザーの操作に正しく反応するか
3. **プロップステスト** - プロップスが正しく処理されるか
4. **状態変更テスト** - 状態の変更が正しく反映されるか

### **Server Actionsのテスト**

```typescript
import { describe, it, expect, vi } from 'vitest';
import { createUser } from './actions';

describe('createUser Server Action', () => {
  it('should create user successfully', async () => {
    const formData = new FormData();
    formData.append('name', 'Test User');
    formData.append('email', 'test@example.com');

    const result = await createUser(formData);

    expect(result.success).toBe(true);
    expect(result.data).toEqual({
      name: 'Test User',
      email: 'test@example.com'
    });
  });
});
```

---

## **AIへの具体的な指示**

### **テストリスト作成時の指示**

```
期待される動作をリストアップし、テスト容易性と重要度で優先順位を付けてください。
実装の詳細ではなく、振る舞いに焦点を当ててください。
境界値分析、同値クラス、デシジョンテーブルなどの論理的なテスト設計手法を活用してください。
```

### **テスト作成時の指示**

```
テストリストから1つだけ選んで、準備・実行・検証が含まれた失敗するテストを書いてください。
アサーションから逆向きに書き進めてください。
Given-When-Thenパターンに基づいて実装してください。
```

### **実装時の指示**

```
テストを成功させる最小限のコードを書いてください。
過度な実装や早すぎる抽象化は避けてください。
全テストをパスするコードを書いてください。
```

### **リファクタリング時の指示**

```
テストを変更せずに、コードをよりシンプルで理解しやすいものにリファクタリングしてください。
すべてのテストが通ることを確認してください。
```

---

## **TDDワークフロー手順**

### **1. 要件の理解**
開発するReactコンポーネントの機能要件と期待される動作を詳細に分析します。
例: 「ボタンをクリックするとテキストが変更される」「リストにアイテムが表示される」など。

### **2. テストリストの作成**
- 振る舞いベースでテスト項目をリストアップ
- テスト容易性と重要度による優先順位付け
- 実装詳細ではなく期待される動作に焦点

### **3. TDDサイクルの実行**
- **レッド**: テストリストから1つずつテストを書く
- **グリーン**: 最小限の実装でテストを通す
- **リファクタリング**: 必要に応じて設計改善

### **4. 繰り返し**
テストリストが完了するまで上記サイクルを継続

---

## **テスト駆動開発のガイドライン**

### **基本方針**
- 期待される入出力に基づき、まずテストを作成
- テストが正しいことを確認できた段階でコミット
- その後、テストをパスさせる実装を進める
- 実装中はテストを変更せず、コードを修正し続ける
- すべてのテストが通過するまで繰り返す

### **AIへのテストの指示方針**
- **許可ベース**: AIには基本的に許可命令を出す
- **禁止命令の回避**: AIの構造上、禁止よりも許可のほうが指示が通りやすい
- **テスト保護**: テストコードは開発者の許可を得てから変更・削除
- **継続的フィードバック**: テストをガードレールとして活用

### **契約による設計の活用**

プロンプトフォーマット例：
```
# 役割
あなたは以下の専門家である
- テストコード
- 契約による設計(事前条件、事後条件、不変条件)

# 目的
テストコード実装

# 制約
- メソッドの事前条件、事後条件、不変条件を検証するテストであること
- Given-When-Thenパターンに基づいて実装すること

# テスト対象
(ここにテスト対象のメソッドを指定する)
```

---

## **VitestとReact Testing Libraryの具体的な使用法**

### **基本API**
- **レンダリング**: `@testing-library/react`の`render`関数を使用
- **要素の取得**: `screen`オブジェクトのメソッド（`getByText`, `getByRole`, `findBy*`, `queryBy*`など）
- **アサーション**: Vitestの`expect`と`@testing-library/jest-dom`のマッチャー（`toBeInTheDocument`, `toHaveTextContent`など）
- **非同期処理**: `async/await`と`findBy*`クエリ、または`waitFor`を使用
- **モック**: Vitestの`vi.mock`を適切に使用してテストの独立性と速度を確保

---

## **よくある誤解と注意点**

### **テスト駆動開発でないもの**
- 設計せずにいきなりテストコードを書き始めること
- テスティングフレームワークを使うことだけを指す
- テストを書けば信頼性が上がるという考え
- 品質保証の手法である

### **テストファーストでないもの**
- 最初にテストコードを全部書いてから実装すること

---

## **テスト戦略**

### **単体テスト**
- コンポーネントの動作テスト
- カスタムフックのテスト
- ユーティリティ関数のテスト

### **統合テスト**
- ユーザーフローのテスト
- データストアの連携テスト
- localStorage操作のテスト

### **E2Eテスト**
- 主要機能のエンドツーエンドテスト
- 複数ブラウザでの動作確認
- パフォーマンステスト

---

## **TDDの効果**

### **短期的効果**
- 開発者のモチベーション向上
- デバッグ時間の削減
- テスト対象の理解促進
- 設計改善のきっかけ

### **長期的効果**
- 記憶力・把握力の限界を補う
- 属人性の軽減
- 継続的な品質向上
- 根拠ある自信の醸成

---

## **Tips**

- **コードの動作に対する不安が退屈に変わる**まで、テストとコーディングを繰り返す
- **小さな挑戦と成功を繰り返す**ことでゲーム感覚で開発する
- **常に必要十分かつシンプルな設計を維持**する
- **フィードバックと改善のプロセス**を組み込んで答えに近づいていく
