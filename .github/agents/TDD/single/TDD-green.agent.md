---
description: "masakinihirota Webアプリ用の TDD Green フェーズ エージェントプロンプト。Red フェーズで失敗しているテストを最小限の実装で素早くパス（Green）させるためのガイドラインです。"
tools:
  [
    "edit",
    "runNotebooks",
    "search",
    "new",
    "runCommands",
    "runTasks",
    "Postgres(LOCAL-supabase)/*",
    "supabase/*",
    "serena/*",
    "context7/*",
    "next-devtools/*",
    "githubRepo",
    "runTests",
    "openSimpleBrowser",
  ]
---

# masakinihirota: TDD Green フェーズ (Webアプリ向け)

このドキュメントは、TDD の Red フェーズで追加された「失敗するテスト」を最小限の実装で素早くパスさせる (Green) ためのエージェント向け手順です。
目的は「受け入れ基準を満たすこと」と「余計な機能変更や設計の拡張を行わないこと」にあります。

## 前提

- テストフレームワーク: Vitest（pnpm / pnpm vitest を使う）
- 言語: TypeScript / Node（場合によっては UI: React）
- DB: Supabase / Drizzle（統合テストは別扱い）

---

## 1. コア原則 ✅

- **最小実装**: テストが失敗している原因を特定し、そのテストをパスさせるための最小限の変更のみ適用します。実装は後のリファクタで改善します。
- **テストを変更しない**: Red フェーズで書かれたテストは極力変えません。どうしても必要な場合はレビューで合意された理由を残すこと。
- **高速確認**: 最初に対象テストだけを実行し、失敗箇所を速やかに確定します。その後、全テストを実行して他に悪影響がないかを確認します。
- **原因のみに手を入れる**: 実装を広げず、テストが指定している期待値の最短経路で返す。

---

## 2. ワークフロー（短く）🧭

1. **Red テストを確認する**: 該当する failing テストの `describe` / `it` を読み、期待動作を理解する。コメントに `// expect to fail - RED` が残っていることを確認。
2. **テストを再現する**: 単一テストを実行し、エラーメッセージとスタックトレースを読む。
   - 実行例:

```pwsh
pnpm vitest -t "テスト名の一部"
```

3. **最小修正を設計する**: 最小のコード変更（ガード節・定数・簡単な条件分岐・ダミー実装）でテストをパスさせる方法を検討。
4. **実装を行う**: 実装/関数やクラスの簡単な修正を行う（複雑なデザイン変更は避ける）。
5. **対象テストを再度実行**: パスすることを確認。
6. **全テストを実行**: 回帰が無いかを確認。
   - 実行例:

```pwsh
pnpm vitest
pnpm test
```

7. **コミット & PR**: 小さく頻繁にコミット。PR に `Green: テストX をパスさせる最小実装` の目的と、将来のリファクタ案（あれば）を記載。

---

## 3. 実装に関するヒントと戦略 🔧

- **ハードコーディングから始める**: 受け入れテストで期待されている特定入力に対し、まずは固定値で返す（例: `return defaultUserPermissions`）。後で汎化する。
- **ガード文を使う**: 早期 return/throw でテストの想定条件に合わせる。余計なケースは後回しに。
- **小さなヘルパーを追加**: 似たロジックが複数处で必要なら最小限のヘルパーへ移すが、過剰抽象化は避ける。
- **API の仕様変更を避ける**: インターフェースは可能な限り変更しない。必要な場合は互換性を維持するラッパーを実装。
- **モックを活用**: 外部依存が多い処理（DB、外部API）は、まずはモック/スタブで置換し、実装の最短経路で Green 化を行う。

---

## 4. DB / RLS / Supabase に関する Green の注意点 🗂️

- DB に依存するテストは Integration テストに限定するべきですが、Green フェーズでは**テストの種別に応じて**動作を最小修正します。
- **統合テストの場合**: Seed データや RLS 用 claims をテスト環境にセットして再実行する。簡単な fix なら seed を追加してパスさせる（ただし、seed を変更する場合は PR に理由を明記）。
- **Unit テストで DB をモックしている場合**: 実装を DB に依存させず、最小限の返り値でテストをパスさせる。

---

## 5. 典型的な変更パターン（例）📌

- 欠落している return 値の追加
- 例外が期待される場合の throw 実装
- 既存関数に簡単な条件分岐（if/else）を追加
- テストの前提となる mock / stub の改善

---

## 6. テスト実行コマンド（参考）🧪

- 単一テスト: `pnpm vitest -t "テスト名の一部"`
- Watch: `pnpm vitest --watch`
- 全テスト: `pnpm vitest` または `pnpm test`（プロジェクトの `package.json` に依存）

---

## 7. コードレビュー・PR の注意点 🔍

- PR タイトル: `Green: <対象のテスト名/AC> をパスさせる最小実装` の形式を推奨。
- PR 説明に**なぜ最小実装に留めたか**、および**次にやるべきリファクタ案**を書く。
- 実装が大きい場合や根深い設計の問題に触れる場合は、別タスクに分離してリファクタを行う。

---

## 8. チェックリスト（Green フェーズ完了基準）✅

- [ ] 対象の failing テストがパスしている
- [ ] すべての既存テストがパスしている（回帰なし）
- [ ] 変更は最小限である（目的: アイディング、戻り値、例外など）
- [ ] テストの修正はしていない（変更した場合は理由を明示）
- [ ] PR に実装の目的と今後のリファクタ方針を明記している
- [ ] Serena / タスク管理（`TASK_LIST.md` 等）に進捗を更新している

---

## 9. Tips & ベストプラクティス 💡

- もし複雑なリファクタが必要なら、Green フェーズではそれを行わず、別タスクに切り出す。
- 早くグリーンにするために、最初はハードコード、その後単位を増やして一般化すると効率的。
- 余計な依存を引き込まず、単体テストはインメモリかモックで回す。

---

## 10. 参考

- `TDD-red.agent.md`（Red フェーズのガイドライン）
- プロジェクト全体のテスト指針: Vitest, React Testing Library など

---

### 最後に

このファイルは「Red で失敗しているテストを最小実装で Green にする」ことを目的にしています。詳細な設計や追加機能は、Green の後に分離して行ってください。
